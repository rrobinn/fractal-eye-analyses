---
title: "R Notebook"
output:
  rmdformats::readthedown:
    highlight: kate
    self_contained: true
---

```{r warning=FALSE, comment = FALSE, message = FALSE, echo = FALSE}
library(tidyverse)
library(ggplot2)
library(knitr)
library(readxl)
library(DT)
wdir = '~/Documents/Github/fractal-eye-analyses/'
options(max.print="75")
opts_chunk$set(echo=FALSE,
               cache=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               include=TRUE)

source(paste(wdir, 'processing/helper_functions/get_date_et.R', sep =''))
```

# About
To get a list of visits, age at visit, and cohort, the following info must be merged:  
 
```{r echo = TRUE}
# Directory where each session has its own sub-directory
data_dir = '~/Box/sifre002/7_MatFiles/01_Complexity/Individual_Data/20201112data/New_Sessions/'
# LORIS query
cohort_csv = '~/Documents/Github/fractal-eye-analyses/data/misc_queries/cohort-2020-12-07.csv'
# DOB query
DOB = read_excel(paste(wdir, "data/misc_queries/20201203_Robin_DOBs_Eyetracking.xlsx", sep = ''), 
                 sheet = "Clean", col_types = c("text", "numeric", "date"))
```
- `data_dir`: Location of <b>eye-tracking data</b> (.tsv and .mat files). If a .tsv in `~/Box/Elab_ET_Data/BCP_BSLERP/AUDIT_PASSED` contains the strings 'CalVer', 'Dancing', 'EU', or 'DL', it will end up with its own subdirectory in `~/AUDIT_PASSED/`.  
- `cohort_csv`: Participant <b>cohort information</b> queried from LORIS.  
- `DOB`: Contains each participant's date of birth. The age at a visit is not easily linked to the session ID. To get this information, I pull the date of visit from the tobii file, and calculate the age based on their DOB (which Eli sends me bc PII).  

<b>Path where final list will be stored:</b>
```{r}
listname = 'Dissertation_ParticList.csv'
out_dir = paste(wdir, 'data/', listname, sep ='')
out_dir
```




## Get date of visit from tobii .tsv
```{r getDateOfVisit, cache = TRUE}
files = list.dirs(data_dir)
# Get date of scan for calculating DOBs from raw tobii file
ids = c()
date_of_vis = c()

for (f in files){
  ids = c(ids, basename(f))
  date_of_vis = c(date_of_vis, get_date_et(f))
}

# Years are not entered in consistent way - fix this. 
date_of_vis = unlist(date_of_vis)
date_split = strsplit(date_of_vis, '/')

# Data.frame to store visit dates 
visit_dates = data.frame(session = ids, 
                         date = as.character(date_of_vis),
                         year = unlist(lapply(date_split, '[', 3)),
                         month = unlist(lapply(date_split, '[', 1)) ,
                         day = unlist(lapply(date_split, '[', 2) ))


# Format visit date 
visit_dates = visit_dates %>%
  mutate(session = as.character(session)) %>%
  mutate(PSCID = paste(lapply(strsplit(session, '_'), '[[', 1),
                       lapply(strsplit(session, '_'), '[[', 2), sep = '_') ) %>%
  # Fix years
  mutate(year = as.numeric(as.character(year)),
         year = year%%2000,
         year = year + 2000) %>%
  mutate(month = as.numeric(as.character(month)),
         day = as.numeric(as.character(day))) %>%
  mutate(visit_date = paste(year,month,day, sep = '-')) 

```

```{r}
head(visit_dates)
```


## Get DOB
```{r}
DOB = DOB %>% dplyr::select(PSCID, DOB)
head(DOB)
```


## Get info on cohort
```{r}
cohort = read.csv(cohort_csv, stringsAsFactors = FALSE)
cohort = cohort %>%
  dplyr::select(CandID = demographics.CandID,
                Cohort = demographics.Cohort,
                PSCID = demographics.PSCID) %>%
  filter(Cohort != 'BCP_CFP') %>% # Feeding visit (not a real vis)
  distinct() 
# Add row number for IDs w/ multiple cohorts 
cohort = cohort %>% group_by(PSCID) %>% mutate(rownum = row_number())
head(cohort)
```

# Merge data 
```{r}
# Merge DOB and Cohort info with list of new visits 
visits = list.dirs(data_dir)
visits = basename(visits)
visits = visits[2:length(visits)]

# Get ID
temp = strsplit(visits, '_')
ids = paste(lapply(temp, '[', 1), lapply(temp, '[', 2), sep = '_')

# Make data.frame
visits = data.frame(session = visits, PSCID = ids, stringsAsFactors=FALSE) # 213 

# Merge DOB
visits = left_join(visits, DOB, by = 'PSCID') # 213

# Merge cohort info
visits$rownum = 1 # Only pull the first cohort for an individual
visits = left_join(visits, cohort, by = c('PSCID', 'rownum'))

# Merge visit dates 
visits = left_join(visits, visit_dates %>% dplyr::select(session, visit_date), by = 'session')

```


```{r}
# Calculate age at visits
visits = visits %>%
  mutate(age = as.Date(visit_date) - as.Date(DOB),
         age = as.numeric(age),
         age = age/30.42)

# Clean up cohort
visits = visits %>%
  mutate(Cohort2 = ifelse(grepl(pattern = 'BCP_A', x = Cohort), 'BCP_A', Cohort),
         Cohort2 = ifelse(grepl(pattern = 'BCP_B', x = Cohort), 'BCP_B', Cohort2),
         Cohort2 = ifelse(grepl(pattern = 'BCP_C', x = Cohort), 'BCP_C', Cohort2),
         Cohort2 = ifelse(grepl(pattern = 'BCP_D', x = Cohort), 'BCP_D', Cohort2),
         Cohort2 = ifelse(grepl(pattern = 'BCP_ELISON', x = Cohort), 'BCP_ELISON', Cohort2),
         Cohort2 = ifelse(grepl(pattern = 'BCP_E', x = Cohort) & Cohort2!='BCP_ELISON', 'BCP_E', Cohort2),
         Cohort2 = ifelse(grepl(pattern = 'BSLERP', x = Cohort), 'BSLERP', Cohort2),
         Cohort2 = ifelse(grepl(pattern = 'DSA', x = Cohort), 'Other', Cohort2),
         Cohort2 = ifelse(grepl(pattern = 'Infant_Face_Tracking', x = Cohort), 'Other', Cohort2)) # DevSocAtt, Infant Face Tracking

```


```{r}
# Data from ms (to see who we already have)
# List of id_sessions & their ages to include to analyses (DOB is identifying info) 
particList = read_csv(file = paste(wdir, 'data/participantList.csv', sep = ''))

# Concatenated output Output from pipeline in fractal-eye-analyses-MFDFA/
h <- read_csv(file = paste(wdir, 'data/h_out.txt', sep = ''))

# Calibration precision spreadsheet  
AvgPrecision <- read.csv( paste(wdir, 'data/et_precision.csv', sep=''), stringsAsFactors = FALSE )
```

```{r ms_participants, cache = TRUE}
min_age = 0
max_age = 40
h = h %>%
  # Create variable for Participant ID (currently combined with session #)
  mutate(Participant = paste(lapply(strsplit(id, '_'), '[', 1), lapply(strsplit(id, '_'), '[', 2), sep='_')) %>%
  left_join(particList, by='id') %>%
  # Create Dummies for CalVer & Pixelated
  mutate(CalVer=ifelse(grepl('Center|Left|Right', movie), 1, 0),
         Pix=ifelse(grepl('S', movie), 1, 0)) %>%
  # Variable to keep track of if theyre in participant list
  mutate(particList = ifelse(id %in% particList$id, 1, 0))

#  Merge precision data
h2= h %>% left_join(AvgPrecision, by='id') 
h2 = h2 %>% mutate( remove_precision = ifelse(is.na(Precision_RMS_X_Y),1,0) )

# Merge age range
h2 = h2 %>% mutate(remove_age = ifelse(age>=min_age & age<=max_age, 0,1))

# Merge prop interp
h2 = h2 %>% mutate(remove_propInterp = ifelse(propInterp>=quantile(propInterp,.8),1,0))

# Merge too short
h2 = h2 %>% mutate(remove_tooshort = ifelse(h==-9999,1,0))

h2 = h2 %>% 
  mutate(excl1 = ifelse(remove_precision==1 | remove_age == 1 | remove_propInterp ==1 | remove_tooshort == 1, 1, 0),
         excl2 = ifelse(remove_precision==1 | remove_age == 1 | remove_propInterp ==1, 1, 0))
```

List of visits from manucript should include those who were excluded.  
```{r echo = TRUE}
dim(h2)
dim(h2 %>% filter(excl1 == 0)) # Exclusionary criteris from 2020 ms
```

```{r echo=TRUE}
old_data = h2 %>%
  filter(excl1 ==0) %>%
  dplyr::select(session = id, Cohort = cohort, PSCID = Participant, age) %>%
  distinct()
```


```{r}
old_data = old_data %>%
  mutate(Cohort2 = ifelse(grepl(pattern = 'BSLERP', x = Cohort), 'BSLERP', Cohort),
         Cohort2 = ifelse(grepl(pattern = 'DevSocAtt', x = Cohort), 'Other', Cohort2),
         Cohort2 = ifelse(grepl(pattern = 'ELISON', x = Cohort), 'BSLERP', Cohort2),
         Cohort2 = ifelse(grepl(pattern = 'E1', x = Cohort), 'BCP_E', Cohort2),
         Cohort2 = ifelse(grepl(pattern = 'A2', x = Cohort) | 
                            grepl(pattern = 'A3', x = Cohort) , 'BCP_A', Cohort2),
         Cohort2 = ifelse(grepl(pattern = 'B1', x = Cohort) |
                            grepl(pattern = 'B2', x = Cohort) |
                            grepl(pattern = 'B3', x = Cohort), 'BCP_B', Cohort2),
         Cohort2 = ifelse(grepl(pattern = 'C1', x = Cohort) |
                            grepl(pattern = 'C2', x = Cohort) |
                            grepl(pattern = 'C3', x = Cohort), 'BCP_C', Cohort2),
         Cohort2 = ifelse(grepl(pattern = 'D1', x = Cohort) |
                            grepl(pattern = 'D2', x = Cohort) |
                            grepl(pattern = 'D3', x = Cohort), 'BCP_D', Cohort2)) 
```


# Final visit list  
Includes visits that were ultimately excluded.  

```{r}
old_data$old = 1
visits$old = 0

# List of sessions that show up in both
to_remove_from_new = intersect(old_data$session, visits$session)
visits = visits %>% filter(!(session %in% to_remove_from_new))

vis_list = rbind(old_data, visits %>% dplyr::select(session, Cohort, PSCID, Cohort, Cohort2, age, old))

datatable(vis_list)
```

<b>List of Cohorts</b>
```{r}
unique(vis_list$Cohort2)
```


<b>visits that are not BSLERP/BCP cohorts</b>  
```{r}
datatable(vis_list %>% filter(Cohort2 == 'Other') %>% dplyr::select(session, Cohort, Cohort2) %>% arrange(session), caption = 'Non BSLERP/BCP Visits')
```

How many visits do DevSocAtt kids have? 
```{r}
DSA_ids = vis_list %>% filter(Cohort2 == 'Other') %>% dplyr::select(PSCID) %>% unique()
vis_list %>%
  filter(PSCID %in% DSA_ids$PSCID) %>%
  dplyr::select(PSCID, Cohort) %>%
  group_by(PSCID) %>%
  summarise(n_visits = n()) %>%
  ungroup() %>%
  count(n_visits)
```


<b>visits with missing cohort info</b>  
```{r}
vis_list %>% filter(is.na(Cohort2)) %>% dplyr::select(session, Cohort, Cohort2) %>% arrange(session)

```


```{r}
# Add age at first visit to help w/ plotting
vis_list2 = vis_list %>%
  group_by(PSCID) %>%
  # Add number of visits (n), and ageFirstVis
  summarise(ageFirstVis = min(age)) %>%
  left_join(., vis_list, by='PSCID') %>%
  ungroup() %>%
  mutate(old = ifelse(old==1, 'Old', 'New'))

```

## Visualize data

### BSLERP
```{r bslerp_longitfig}
vis_list2 %>% filter(Cohort2=='BSLERP') %>%
ggplot(data = ., aes(y = reorder(PSCID, ageFirstVis), x = age)) +
  geom_point(aes(color = old), size=1) +
  geom_line() +
  theme(axis.text.y=element_blank()) + 
  scale_y_discrete()+
  labs(x = 'Dancing Ladies Age (months)', y = 'Individual', title='BSLERP') 

```


```{r}
# Make df where each PSCID is a row, and New=Oldest age at newly processed vis, Old=Oldest age at visit already processed 
age_flag = vis_list2 %>%
  dplyr::select(PSCID, age, old) %>% 
  group_by(PSCID, old) %>%
  summarise(oldestVis = max(age)) %>%
  spread(key=old, value=oldestVis) %>%
  # If they only were processed in the first OR second batch, don't need to check
  filter(!is.na(New) & !is.na(Old)) %>%
  # If the oldest age at old=='Old' > oldest age at old=='New', flag 
  mutate(flag = ifelse(Old > New,1,0))

datatable(age_flag %>% 
            filter(flag ==1) %>% 
            dplyr::select(-c(flag)) , 
          colnames = c('PSCID', 'Max age in new batch', 'Max age in old batch'),
          caption = 'Cases where we missed a visit in manuscript')
```



```{r}
ids_to_check = age_flag %>% filter(flag ==1) %>% dplyr::select(PSCID) 

vis_list2 %>% 
  filter(Cohort2=='BSLERP',
         PSCID %in% ids_to_check$PSCID) %>%
ggplot(data = ., aes(y = reorder(PSCID, ageFirstVis), x = age)) +
  geom_point(aes(color = old), size=1) +
  geom_line() +
  theme() + 
  scale_y_discrete()+
  labs(x = 'Dancing Ladies Age (months)', y = 'Individual', title='BSLERP') 

```





### BCP
```{r bcp_ab_longitfig}
vis_list2 %>% filter(grepl('BCP_A|BCP_B', Cohort2)) %>%
ggplot(data = ., aes(y = reorder(PSCID, ageFirstVis), x = age)) +
  geom_point(aes(shape = old)) +
  geom_line(aes(color = Cohort2)) +
  theme(axis.text.y=element_blank()) + 
  scale_y_discrete()+
  labs(x = 'Dancing Ladies Age (months)', y = 'Individual', title='BCP-A, BCP-B') 
```



```{r bcp_cd_longitfig}
vis_list2 %>% filter(grepl('BCP_C|BCP_D|BCP_E', Cohort2)) %>%
ggplot(data = ., aes(y = reorder(PSCID, ageFirstVis), x = age)) +
  geom_point(aes(shape = old)) +
  geom_line(aes(color = Cohort2)) +
  theme(axis.text.y=element_blank()) + 
  scale_y_discrete()+
  labs(x = 'Dancing Ladies Age (months)', y = 'Individual', title='BCP-C, D, E') 
```


We didn't miss any earlier BCP visits in the manuscript
```{r}
vis_list2 %>% 
  filter(grepl('BCP', Cohort2),
         PSCID %in% ids_to_check$PSCID) 
```

### DevSocAtt
```{r other_longitfig}
vis_list2 %>% filter(grepl('Other', Cohort2) | is.na(Cohort2)) %>%
ggplot(data = ., aes(y = reorder(PSCID, ageFirstVis), x = age, color = old)) +
  geom_point() +
  geom_line() +
  theme(axis.text.y=element_blank()) + 
  scale_y_discrete()+
  labs(x = 'Dancing Ladies Age (months)', y = 'Individual', title='Other') 
```


## Final tallies

<b>What happened w/ missing visits?</b>  
Seems that they did not appear in the exported .nas file.  
```{r echo = TRUE}
head(ids_to_check)
vis_list2 %>% 
  filter(PSCID == ids_to_check$PSCID[1]) %>%
  dplyr::select(PSCID, session, age, old) 
```



When I search for their ID in directory w/ the raw .tsvs, '_04' is not there:
```{r}
list.files('/Users/sifre002/Box/sifre002/9_ExcelSpreadsheets/Dancing_Ladies/RawData_DancingLadies_1', pattern='JE000094', no.. = TRUE)
```


How many new kids
```{r}
new_vis = vis_list2 %>% filter(old == 'New') 
old_vis = vis_list2 %>% filter(old == 'Old')

# List of IDs that were not in the manuscript
new_partic = setdiff(new_vis$PSCID, old_vis$PSCID)
length(unique(new_partic))
```

Cohorts the new kids are from 
```{r}
# Which cohorts are they from?
vis_list2 %>%
  filter(PSCID %in% new_partic) %>%
  count(Cohort2)
```

How many new visits
```{r}
nrow(new_vis)
```

Of participants with new visits who were in the old MS, which cohorts are they in?
```{r}
new_vis %>%
  filter(PSCID %in% old_vis$PSCID) %>%
  count(Cohort2)

```

```{r}
write.csv(x = vis_list2, file = paste(out_dir, sep =''))
```

