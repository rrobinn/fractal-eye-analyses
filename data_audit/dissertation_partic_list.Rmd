---
title: "R Notebook"
output:
  rmdformats::readthedown:
    highlight: kate
    self_contained: true
---

```{r libraries, warning=FALSE, results ='hide', message = FALSE, echo = FALSE}
library(tidyverse)
library(ggplot2)
library(knitr)
library(readxl)
library(DT)
library(miceadds)
library(stringr)
library(lubridate)

wdir = '~/Documents/Github/fractal-eye-analyses/'
options(max.print="75")
opts_chunk$set(echo=FALSE,
               cache=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               include=TRUE)

source.all(paste(wdir, 'analysis/Rfuncs/', sep =''))
```

# About

Document generates a list of visits to be included in my dissertation. Does not take QA/QC into account.

```{r loaddata, echo = TRUE, cache = TRUE}
# Directory where audited filse are
audit_dir = '~/Box/Elab_ET_Data/BCP_BSLERP/AUDIT_PASSED'
# List of visit dates in AUDIT_PASSED
visit_date_file = '~/Documents/GitHub/fractal-eye-analyses/data_audit/2021-02-23files_in_AUDIT_PASSED.csv'
# List of pconns (files included in the group & individual FC matrices generated by `Connectivity-Matrix.Rmd)
pconn_file = '~/Documents/GitHub/RS-Functional-Connectivity-Models/data/audit/files_in_connectivity_mat.csv'
# Info of kids not yet in LORIS
dsa_file = paste(wdir, 'data/misc_queries/misc_dsa_dob.csv', sep = '')
```


<b>Path where final list will be stored:</b>
```{r}
listname = 'Dissertation_ParticList.csv'
out_dir = paste(wdir, 'data_audit/', sep ='')
out_dir
```
<b> List of output files </b>  
- `visit_dates.RData`: List of visit dates from all directories in `~/BCP_BSLERP/AUDIT_PASSED/`  
- `potential_etvis_in_loris.csv`: Merges `visit_dates.RData` with info on whether I found an eye-tracking visit, the date of the visit, etc.  Reflects data in `loris2`

<b>Important data structures</b>  
- `loris_vis`: List of all potential eye-tracking visits from LORIS.  
- `loris_vis2`: Visits that happened pre-COVID, excluding IFT, bcpCFP, and bcpOther.  
- `et`: Visits excluding cases where I did not find any ET data.    

  
# ET data audit

## 0. Use session table from LORIS to get list of visits for each participant  
This data.frame is generated by `list_of_visits.R` and is used to generate `loris_vis` and `indiv-dat` (DOB, cohort, sex).
```{r loris_vis, echo = TRUE, include = FALSE}
# visit_list.txt: Output of session table query
# BCP_info.txt: Output of metadata on BCP visit schedule
loris_vis <- list_of_visits(path_to_session_query = '~/Documents/GitHub/fractal-eye-analyses/data/misc_queries/visit_list.txt', 
                           path_to_bcpVisitOrder_query = '~/Documents/GitHub/fractal-eye-analyses/data/misc_queries/BCP_info.txt') 

# Remove babar
loris_vis = loris_vis %>%
  filter(!grepl('babar', cohort)) %>%
  # Don't count as potential visit if it will happen in the future 
  filter(!is.na(VisitNo))
```

```{r indiv_metadata}
# Pull Individual-level data 
# (CandID,PSCID,cohort,DOB,Sex)
# # # # # # # # # # # # # # # # 
indiv_dat = loris_vis %>% 
  dplyr::select(CandID,  PSCID, cohort,DOB, Sex) %>% 
  filter(!grepl('babar', cohort)) %>%
  distinct() %>%
  # Format DOB as date
  mutate(DOB = as.Date(DOB)) 

# Cases where people have more than one cohort - bcpELISON, bcpCFP, bcpOther1
dups = indiv_dat %>%
  group_by(CandID) %>%
  mutate(n=n()) %>%
  filter(n>1) %>%
  pull(CandID)

# For cases with multiple rows (they are in more than one cohort), flag which row(s) to keep, and keep one of those rows 
indiv_dat = indiv_dat %>%
  mutate(usecohort = ifelse(CandID %in% dups & grepl('bcpELISON|bcpCFP|bcpOther1', cohort), 0, 1)) %>%
  group_by(CandID) %>%
  arrange(usecohort, .by_group = TRUE) %>%
  slice(n()) %>%
  ungroup() %>%
  select(-c(usecohort)) %>%
  rename(cohort2=cohort)
```




```{r clean_cohort}
# Clean up cohort
loris_vis = loris_vis %>%
  left_join(indiv_dat %>% dplyr::select(CandID, cohort2), by = 'CandID') %>%
mutate(cohort2 = ifelse(grepl(pattern = 'bcpBSLERP', x = cohort2, ignore.case = TRUE), 'BSLERP', cohort2), 
        cohort2 = ifelse(grepl(pattern = 'BCPA', x = cohort2, ignore.case = TRUE), 'BCP_A', cohort2),
         cohort2 = ifelse(grepl(pattern = 'BCPB', x = cohort2, ignore.case = TRUE), 'BCP_B', cohort2),
         cohort2 = ifelse(grepl(pattern = 'BCPC', x = cohort2, ignore.case = TRUE), 'BCP_C', cohort2),
         cohort2 = ifelse(grepl(pattern = 'BCPD', x = cohort2, ignore.case = TRUE), 'BCP_D', cohort2),
         cohort2 = ifelse(grepl(pattern = 'BCPELISON', x = cohort2, ignore.case = TRUE), 'BCP_ELISON', cohort2),
         cohort2 = ifelse(grepl(pattern = 'BCPE', x = cohort2, ignore.case = TRUE) & cohort2!='BCP_ELISON', 'BCP_E', cohort2),
         cohort2 = ifelse(grepl(pattern = 'BSLERP', x = cohort2, ignore.case = TRUE), 'BSLERP', cohort2),
         cohort2 = ifelse(grepl(pattern = 'dsa|ift', x = cohort2, ignore.case = TRUE), 'dsa_ift', cohort2)) %>%
  # Pull visit_label_age
  mutate(Visit_label_age = lapply(strsplit(Visit_label, 'x'), '[', 2),
         Visit_label_age = unlist(Visit_label_age),
         Visit_label_age = gsub(pattern = 'm', replacement = '', Visit_label_age),
         Visit_label_age = ifelse(Visit_label_age == 'Birth2wk', "0.5", Visit_label_age),
         Visit_label_age = as.numeric(Visit_label_age)) 
```

### Merge info about DSA kids
```{r devsocatt}
# Merge the DSA kids with indiv_dat
dsa = read.csv(dsa_file, stringsAsFactors = FALSE)
dsa = dsa %>%
  filter(grepl('DevSocAtt', IRB)) %>%
  select(CandID, PSCID, 
         DOB = Subject_DOB,
         cohort2 = IRB,
         Sex = Subject_Sex) %>%
  # Fix PSCID
  mutate(PSCID = paste(sapply(strsplit(PSCID, '_'), '[', 1),
                       sapply(strsplit(PSCID, '_'), '[', 2), sep = '_')) %>%
  mutate(DOB = mdy(DOB)) %>%
  # Fix CandID (if there are 2 just pick the first - dont think I'll be using it)
  mutate(CandID = ifelse(grepl('&', CandID),
                         sapply(strsplit(CandID, '&'), '[', 1),
                         CandID),
         CandID = as.integer(CandID))
indiv_dat = bind_rows(indiv_dat, dsa)
```

### List of missing cohort, DOB or sex for anyone in `indiv_dat`.  
Looks like these are not in LORIS. May have dropped out? Investigate if they actually have ET data. 
```{r}
indiv_dat_missing_info = indiv_dat %>% filter(is.na(CandID) | is.na(DOB) | is.na(Sex) | is.na(PSCID))
indiv_dat_missing_info
```



## 1. Get date of visits in `~/AUDIT_PASSED/`.  
- Should include all directories (even those without Calver or DL).  
- Used to calculate age at visit & match with the visits in `loris_vis`
```{r dates_in_audit_passed, echo=FALSE, cache = TRUE}
# All parent directories (individuals)
ids = list.dirs(audit_dir, full.names = TRUE, recursive = FALSE) 

vis_list = list()
count =1 
for (i in ids) {
  id = basename(i)

  # list visits with ET data 
  vis_dirs = list.dirs(i, full.names = FALSE, recursive=FALSE) # e.g. v01, v02

  for (v in vis_dirs){
    session = paste(id,
                    gsub(pattern='v0', replacement = '_0', v), sep='')

    # Determine if there is DL/Calver data for this visit 
    dl_flag = 0
    cal_flag = 0 
    
    # Pull sub-dirs to get list of tasks  
    tasks = list.dirs(paste(i, v, sep='/'), recursive = FALSE, full.names = FALSE)
    
    if (sum(grepl('cal', tasks, ignore.case=TRUE) != 0)) cal_flag=1
    if (sum(grepl('eu-aims', tasks, ignore.case=TRUE) != 0)) dl_flag =1
    
    # Get recording date (only need to do this from one file in a visit)
    f = list.files(paste(i, v, tasks[1], sep='/'), full.names = TRUE)[1]
    d = get_date_et(f)
    
    # Log the session, date, and if there was calver/DL
    vis_list[[count]]  =  paste(session, d, dl_flag, cal_flag, sep = ',')
    count = count + 1 
    
    }

  }

# Convert list output to data.frame
df = unlist(vis_list)
vis = unlist(lapply(strsplit(df, ','), '[[', 1))
date = unlist(lapply(strsplit(df, ','), '[[', 2))
dl_flag = unlist(lapply(strsplit(df, ','), '[[', 3))
cal_flag = unlist(lapply(strsplit(df, ','), '[[', 4))

visit_dates = data.frame(vis=vis, date=date, dl_flag=dl_flag, cal_flag = cal_flag)
# reformat date 
visit_dates = visit_dates %>% 
  mutate(date = mdy(date)) %>%
  arrange(vis)

```

```{r save_visit_dates, echo = TRUE}
save(visit_dates, file=paste(out_dir, Sys.Date(), 'visit_dates.RData', sep = ''))
```

### Visits with no Calver or DL (should have TAFI)
```{r}
visit_dates %>% filter(dl_flag==0 & cal_flag==0)
```


```{r calc_age_from_visdate}
# Use visit date to calculate age at visit 
visit_dates=visit_dates %>%
  rename(visit_date=date, ids=vis) %>%
  # Disregard babar
  filter(!grepl('bab|pheno', ids, ignore.case=TRUE)) %>%
  # Create PSCID for merging
  mutate(PSCID=paste(sapply(strsplit(ids, '_'), '[', 1), sapply(strsplit(ids, '_'), '[', 2), sep='_')) %>% 
  # Merge indiv_dat with visit_dates & calc age at visit 
  left_join(indiv_dat, by = 'PSCID') %>%
    mutate(age = visit_date - DOB,
           age = as.numeric(age),
           age = age/30.42)
```


Which PSCIDs in `~/AUDIT_PASSED/` are NOT in `indiv_dat` (reflects someone entered ID incorrectly)? 
```{r}
missing = visit_dates %>%
  filter(!grepl('Bab', PSCID)) %>%
  filter(!(PSCID %in% indiv_dat$PSCID)) %>% 
  arrange(PSCID) %>% 
  select(PSCID, ids, visit_date) %>%
  mutate(fam_id = sapply(strsplit(PSCID, '_'), '[' ,1))

# Pull first part of ID only to see if error with _03 vs _04
indiv_dat = indiv_dat %>%
  mutate(fam_id = sapply(strsplit(PSCID, '_',), '[', 1))

missing %>% filter(fam_id %in% indiv_dat$fam_id)
```
JE000088_04 - visit date is 2014-12-08.  Only visit on this date is JE000083_04_01, and they do not exist elsewhere.  
JE000100_03  
JE000166_03_04 - Missing consent date but i think it's JE000166_04. unclear  
MNBCP000156_05_02 - MNBCP000156_04 should be in the sheet  

```{r echo }
# visit_dates %>% 
#   filter(!grepl('Bab|Pheno', ids)) %>%
#   filter(!(ids %in% missing)) %>%
#   filter(is.na(PSCID) | is.na(CandID) | is.na(DOB) | is.na(Sex)) %>% datatable()
# 
# JE000206_03_01 - No record in either the calendar, BCP/BSLERPÂ tracking sheets or Loris  
# JE000885_03_01 - this should be in dsa. dates match.  
# JE000887_03_01 - 887_03 should be in dsa.  
```



## 2. Merge eye tracking meta-data with loris_vis
- For each eye-tracking .tsv, find the visit in LORIS that has the closest date to when the data were collected.  
- Update `loris_vis` (below) with the name of the ET session & the date it was collected.  
- Calculate `et_age` and flag if the visit had Dancing Ladies and/or Calver.  
```{r}
loris_vis$Date_visit = as.Date(loris_vis$Date_visit)
loris_vis$et_collected = NA
loris_vis$et_date = NA
loris_vis$et_date = as.Date(loris_vis$et_date)
loris_vis$et_age = NA
loris_vis$DL_flag = NA
loris_vis$Cal_flag = NA
```

```{r find_closest_et_vis, cache=TRUE}
no_match = c()
# For each eye-tracking visit, find closest visit in loris_vis and add flag
for (i in c(1:nrow(visit_dates))) {
  temp = visit_dates[i,]
  
  # Find visit in LORIS that has the closest date to when data were collected
  date_array = loris_vis %>% 
    filter(PSCID == temp$PSCID) %>%
    pull(Date_visit)
  
  # If there is no match, log & skip
  if (length(date_array)==0) {
    no_match = c(no_match, temp$ids)
    next
  }
  
   closest_ind = which.min(as.numeric(abs(date_array - temp$visit_date)))
   closest_date = date_array[closest_ind]
  
   # Update loris_vis with the name of this eye-tracking session & date it was collected 
   loris_vis[compareNA(loris_vis$Date_visit, closest_date) & loris_vis$PSCID == temp$PSCID, 'et_collected'] = temp$id
   loris_vis[compareNA(loris_vis$Date_visit, closest_date) & loris_vis$PSCID == temp$PSCID, 'et_date'] = temp$visit_date
   loris_vis[compareNA(loris_vis$Date_visit, closest_date) & loris_vis$PSCID == temp$PSCID, 'et_age'] = temp$age
   loris_vis[compareNA(loris_vis$Date_visit, closest_date) & loris_vis$PSCID == temp$PSCID, 'Cal_flag'] = temp$cal_flag
   loris_vis[compareNA(loris_vis$Date_visit, closest_date) & loris_vis$PSCID == temp$PSCID, 'DL_flag'] = temp$dl_flag
  }
```

```{r}
loris_vis %>% 
  dplyr::select(CandID, PSCID, cohort, cohort2, Date_visit, 
                VisitNo, et_collected, et_date, Cal_flag, DL_flag) %>%
  head()
```


```{r save_vis_audit, echo=TRUE}
# Figure out last date data were collected (COVID)
last_date = loris_vis %>% filter(!is.na(et_collected)) %>% pull(et_date) %>% max()
# How many visits would we expect there to be ET for?
loris_vis2 = loris_vis %>%
  filter(Date_visit <= last_date) %>% 
  filter(!grepl('ift|bcpCFP|bcpOther1', cohort))
```

## Visits with ET data  
```{r}
et = loris_vis2 %>% filter(!is.na(et_collected))
datatable(et %>%
            select(CandID, cohort, cohort2, VisitNo, Scan_done, 
                   Date_visit, PSCID, et_collected) %>%
            mutate(et_flag = ifelse(is.na(et_collected), 0, 1),
                   et_flag = factor(et_flag)) %>%
            mutate(cohort = factor(cohort), cohort2 = factor(cohort2)), filter = 'top')
```


### By cohort 
Indicates if they have a visit directory in `~/AUDIT_PASSED/`
```{r}
loris_vis2 %>% group_by(cohort) %>%
  summarize(`Number of visits with eye-tracking data` = sum(!is.na(et_collected)),
            `Number of visits` = n())
```

### By visit labl
```{r}
loris_vis2 %>% group_by(Visit_label) %>%
  summarize(`Number of visits with eye-tracking data` = sum(!is.na(et_collected)),
            `Number of visits` = n()) %>% datatable(filter='top')
```


## Are there specific months when we are missing more data?  
- Based on BCP & BSLERP kids only (excluding bcpCFP, ift).  
- .nas files are not exported every month - so you don't need 100% missing data in a month for there to be a potential missing .nas file.  
```{r}
to_plot = loris_vis2 %>%
  filter(cohort!='dsaDemo') %>%
  select(et_collected, cohort, cohort2, Date_visit) %>%
  mutate(month = month(Date_visit),
         year = year(Date_visit),
         et_flag = ifelse(is.na(et_collected), 0, 1)) %>%
  group_by(year,month) %>%
  summarize(n_collected = sum(et_flag==1),
            n_missing = sum(et_flag==0)) %>%
  ungroup()
```

## Cases with no ET data 


### 2015  

<b> Potential locations</b> 
- Slerpy_export_2015_06_09.nas - move to Box 
-  SLERPY_2015_04_02  - Working on naming errors 

```{r}
to_plot %>%
  pivot_longer(cols = c(n_collected, n_missing), names_to ='status', values_to='count') %>%
  mutate(month = as.integer(month),
         status = ifelse(status=='n_collected', 'collected', 'missing'),
         status = factor(status, levels = c('collected', 'missing'), ordered = TRUE)) %>%
  filter(year ==2015) %>%
  ggplot(data = ., aes(fill = status, y=count, x=month)) +
    geom_bar(position = 'stack', stat='identity') +
    scale_x_continuous(breaks = c(1:12), labels = c(1:12)) + 
    labs(title = '2015')
```


### 2016
```{r}
to_plot %>%
  pivot_longer(cols = c(n_collected, n_missing), names_to ='status', values_to='count') %>%
    mutate(month = as.integer(month),
         status = ifelse(status=='n_collected', 'collected', 'missing'),
         status = factor(status, levels = c('collected', 'missing'), ordered = TRUE)) %>%
  filter(year ==2016) %>%
  ggplot(data = ., aes(fill = status, y=count, x=month)) +
    geom_bar(position = 'stack', stat='identity') +
    scale_x_continuous(breaks = c(1:12), labels = c(1:12))+ 
    labs(title = '2016')
```

### 2017
```{r}
to_plot %>%
  pivot_longer(cols = c(n_collected, n_missing), names_to ='status', values_to='count') %>%
  mutate(month = as.integer(month),
         status = ifelse(status=='n_collected', 'collected', 'missing'),
         status = factor(status, levels = c('collected', 'missing'), ordered = TRUE)) %>%
  filter(year ==2017) %>%
  ggplot(data = ., aes(fill = status, y=count, x=month)) +
    geom_bar(position = 'stack', stat='identity') +
    scale_x_continuous(breaks = c(1:12), labels = c(1:12))+ 
    labs(title = '2017')
```

### 2018
```{r}
to_plot %>%
  pivot_longer(cols = c(n_collected, n_missing), names_to ='status', values_to='count') %>%
  mutate(month = as.integer(month),
         status = ifelse(status=='n_collected', 'collected', 'missing'),
         status = factor(status, levels = c('collected', 'missing'), ordered = TRUE)) %>%
  filter(year ==2018) %>%
  ggplot(data = ., aes(fill = status, y=count, x=month)) +
    geom_bar(position = 'stack', stat='identity') +
    scale_x_continuous(breaks = c(1:12), labels = c(1:12))+ 
    labs(title = '2018')
```

### 2019
```{r}
to_plot %>%
  pivot_longer(cols = c(n_collected, n_missing), names_to ='status', values_to='count') %>%
  mutate(month = as.integer(month),
         status = ifelse(status=='n_collected', 'collected', 'missing'),
         status = factor(status, levels = c('collected', 'missing'), ordered = TRUE)) %>%
  filter(year ==2019) %>%
  ggplot(data = ., aes(fill = status, y=count, x=month)) +
    geom_bar(position = 'stack', stat='identity') +
    scale_x_continuous(breaks = c(1:12), labels = c(1:12))+ 
    labs(title = '2019')
```

### 2020
```{r}
to_plot %>%
  pivot_longer(cols = c(n_collected, n_missing), names_to ='status', values_to='count') %>%
  mutate(month = as.integer(month),
         status = ifelse(status=='n_collected', 'collected', 'missing'),
         status = factor(status, levels = c('collected', 'missing'), ordered = TRUE)) %>%
  filter(year ==2020) %>%
  ggplot(data = ., aes(fill = status, y=count, x=month)) +
    geom_bar(position = 'stack', stat='identity') +
    scale_x_continuous(breaks = c(1:12), labels = c(1:12))+ 
    labs(title = '2020')
```



# Eye-tracking Figures
```{r prep_et_data_for_plotting}
# Make variable for age at first visit
loris_vis2 = loris_vis2 %>% 
  group_by(CandID) %>%
  summarize(n_et = sum(!is.na(et_collected)),
            ageFirstVis = ifelse(n_et>0, min(et_age,na.rm=TRUE), NA)) %>%
  ungroup() %>%
  right_join(loris_vis2, by = 'CandID') %>%
 # Format variables
  mutate(CandID = as.factor(CandID)) %>%
  mutate(DOB = as.Date(DOB)) %>%
  mutate(status = ifelse(is.na(et_collected), 'No visit', 'Has Data'))
```


```{r et_bslerp_fig, cache=TRUE, fig.width=12, fig.height=10}

plot_dat1 = loris_vis2 %>%
  filter(n_et > 0) %>%
  filter(cohort2=='BSLERP')  %>%
  filter(Visit_label_age!=18,
         ageFirstVis < 5)

plot_dat2 = loris_vis2 %>%
  filter(n_et > 0) %>%
  filter(cohort2=='BSLERP')  %>%
  filter(Visit_label_age!=18,
         ageFirstVis >= 5)

ggplot(data = plot_dat1, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
  geom_line(color = 'grey') +
  geom_point(aes(color=status), size=1.1) +
  scale_color_manual(values = c('springgreen4', 'red')) +
  scale_x_continuous(breaks = c(3, 4, 6, 7, 9, 10, 12, 13, 24, 30, 36))+
  scale_y_discrete()+
  theme_bw() + 
  labs(x = 'ET Age (months)', y = 'Individual', title='BSLERP - 1') 

ggplot(data = plot_dat2, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
  geom_line(color = 'grey') +
  geom_point(aes(color=status), size=1.1) +
  scale_color_manual(values = c('springgreen4', 'red')) +
  scale_x_continuous(breaks = c(3, 4, 6, 7, 9, 10, 12, 13, 24, 30, 36))+
  scale_y_discrete()+
  theme_bw() + 
  labs(x = 'ET Age (months)', y = 'Individual', title='BSLERP - 2') 

```

```{r etfig_bcpa, fig.width = 12,fig.height = 10}
plot_dat = loris_vis2 %>%  
  filter(n_et > 0) %>%
  filter(cohort2=='BCP_A') 

ggplot(data = plot_dat, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
  geom_line(color = 'grey') +
  geom_point(aes(color=status), size=1.1) +
  scale_color_manual(values = c('springgreen4', 'red')) +
  scale_x_continuous(breaks = c(2, 4, 8, 10, 13, 24)) + 
  scale_y_discrete()+
  theme_bw() + 
  labs(x = 'ET Age (months)', y = 'Individual', title='BCP-A') 
```

```{r etfig_bcpb, fig.width = 12,fig.height = 10}
plot_dat = loris_vis2 %>%  
  filter(n_et > 0) %>%
  filter(cohort2=='BCP_B') 

ggplot(data = plot_dat, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
  geom_line(color = 'grey') +
  geom_point(aes(color=status), size=1.1) +
  scale_color_manual(values = c('springgreen4', 'red')) +
  scale_x_continuous(breaks = c(2, 4, 8, 10, 13, 24)) + 
  scale_y_discrete()+
  theme_bw() + 
  labs(x = 'ET Age (months)', y = 'Individual', title='BCP-B') 
```


```{r etfig_bcpcd, fig.width = 12,fig.height = 10}
plot_dat = loris_vis2 %>%  
  filter(n_et > 0) %>%
filter(cohort2=='BCP_C' | cohort2 == 'BCP_D') 

ggplot(data = plot_dat, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
 geom_line(color = 'grey') +
  geom_point(aes(color=status), size=1.1) +
  scale_color_manual(values = c('springgreen4', 'red')) +
  scale_x_continuous(breaks = c(2, 4, 8, 10, 13, 24, 28, 32, 36)) + 
  scale_y_discrete()+
  labs(x = 'ET Age (months)', y = 'Individual', title='BCP-C, BCP-D') 
```

```{r etfig_bcp_e, fig.width = 12,fig.height = 10, cache=TRUE}
plot_dat = loris_vis2 %>%  
  filter(n_et > 0) %>%
filter(cohort2=='BCP_E' | cohort2 == 'BCP_ELISON') 

ggplot(data = plot_dat, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
 geom_line(color = 'grey') +
  geom_point(aes(color=status), size=1.1) +
  scale_color_manual(values = c( 'springgreen4', 'red')) +
  scale_x_continuous(breaks = c(2, 4, 8, 10, 13, 24)) + 
  scale_y_discrete()+
  labs(x = 'ET Age (months)', y = 'Individual', title='BCP-E, BCP-ELISON') 
```

```{r etfig_other, fig.width = 12,fig.height = 10, cache=TRUE}
plot_dat =loris_vis2 %>%  
  filter(n_et > 0) %>%
filter(grepl('other|ift', cohort2)) 

ggplot(data = plot_dat, aes(y = reorder(CandID, ageFirstVis), x = et_age)) +
  geom_line(color = 'grey') +
  geom_point(aes(color=status), size=1.1) +
  scale_color_manual(values = c('springgreen4', 'red')) +
  scale_x_continuous(breaks = c(2, 4, 8, 10, 13, 24)) + 
  scale_y_discrete()+
  labs(x = 'ET Age (months)', y = 'Individual', title='IFT, DSA') 
```



```{r clean_etfgs}
loris_vis2 %>%
  filter(!is.na(et_collected)) %>%
  filter(cohort2=='BSLERP') %>%
    ggplot(data = ., aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
    geom_point(size=1.1) +
    geom_line() +
    scale_y_discrete()+
    theme(axis.text.y=element_blank()) + 
    theme_bw() + 
    labs(x = 'Visit Age (months)', y = 'Individual', title='Visits with et data (BSLERP)') 


loris_vis2 %>%
  filter(!is.na(et_collected)) %>%
  filter(cohort2=='BCP_A' | cohort2=='BCP_B' | cohort2=='BCP_C') %>%
    ggplot(data = ., aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
    geom_point(aes(color=cohort2), size=1.1) +
    geom_line() +
    scale_y_discrete()+
    theme(axis.text.y=element_blank()) + 
    theme_bw() + 
    labs(x = 'Visit Age (months)', y = 'Individual', title='Visits with et data') 

loris_vis2 %>%
  filter(!is.na(et_collected)) %>%
  filter(cohort2=='BCP_C' | cohort2=='BCP_D') %>%
    ggplot(data = ., aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
    geom_point(aes(color=cohort2), size=1.1) +
    geom_line() +
    scale_y_discrete()+
    theme(axis.text.y=element_blank()) + 
    labs(x = 'Visit Age (months)', y = 'Individual', title='Visits with et data') 

loris_vis2 %>%
  filter(!is.na(et_collected)) %>%
  filter(cohort2=='BCP_E' | cohort2=='BCP_ELISON' | cohort2=='dsa_ift') %>%
    ggplot(data = ., aes(y = reorder(CandID, ageFirstVis), x = et_age)) +
    geom_point(aes(color=cohort2), size=1.1) +
    geom_line() +
    scale_y_discrete()+
    theme(axis.text.y=element_blank()) + 
    labs(x = 'Visit Age (months)', y = 'Individual', title='Visits with et data') 
```

# Save list et meta-data
```{r echo=TRUE}
write.csv(x=loris_vis2, file=paste(out_dir, 'potential_etvis_in_loris.csv', sep='') )
```



```{r}
knit_exit()
```



# MRI data audit

## 1. Read .pconn file (contains paths to all .pconns)

```{r pconns_mesabi}
# Data pulled from mesabi
# listofpconns <- read.table(pconn_file, quote="\"", comment.char="", stringsAsFactors = FALSE)
listofpconns <- read.csv(pconn_file, stringsAsFactors = FALSE)

listofpconns = listofpconns %>%
  dplyr::select(fname = x) %>%
  # remove file names that arent sub-123456_ses-XXmo_corr
  filter(grepl('sub-', fname)) %>%
  mutate(id_nums = gsub("\\D+", "", fname),
         CandID = substring(id_nums, 1, 6),
         vis = as.numeric(id_nums)%%as.numeric(CandID),
         CandID = as.integer(CandID)) %>%
  dplyr::select(-c(id_nums)) %>%
  # Get rid of duplicates (m_corr vs mo_corr)
  mutate(fname = gsub(x = fname, pattern = 'mo', replacement='m')) %>%
  distinct() %>% 
  arrange(CandID)

datatable(listofpconns, colnames=c('Directory name', 'CandID', 'Visit'), filter='top')
```


## 2. Merge `listofpconns` with `loris_vis`

```{r merge_pconns_lorisVis2}
loris_vis2$rs_collected = NA

# For every visit in list of pconns
for (i in 1:nrow(listofpconns)) {
  temp = listofpconns[i, ]
  id = temp$CandID
  age= temp$vis
  
  # Pull all visits for this CandID
  vis = loris_vis2 %>% 
    filter(CandID == id) %>%
    mutate(temp_age = Date_visit - as.Date(DOB),
            temp_age = as.numeric(temp_age)/30.42)
  
  # If there is an exact visit age match 
  if (age %in% vis$Visit_label_age) {
    closest_age = age
    loris_vis2[compareNA(id, loris_vis2$CandID) & compareNA(age, loris_vis2$Visit_label_age), 'rs_collected'] = temp$fname
  } else { 
    # Otherwise, find the closest one
    min_ind = which.min(abs(vis$temp_age - age))
    closest_vis = vis[min_ind, 'Visit_label']
    loris_vis2[compareNA(id, loris_vis2$CandID) & loris_vis2$Visit_label == closest_vis, 'rs_collected'] = temp$fname
  }
}
  
```

# Final

```{r}
# Determine who has at least one scan OR one et visit
scan_flag = loris_vis2 %>%
  group_by(CandID) %>%
  summarize(n_scan = sum(!is.na(rs_collected)) ) %>%
  ungroup()
loris_vis2 = loris_vis2 %>%
  left_join(scan_flag, by = 'CandID')
```

## Individuals in loris_vis with no ET & no MRI

```{r echo=TRUE}
loris_vis2 %>% 
  filter(n_et==0 & n_scan==0) %>%
  select(CandID, PSCID, cohort, Visit_label) %>%
  mutate(cohort = factor(cohort)) %>% # Makes filtering easier
  datatable(filter = 'top')
```



```{r}
# et=loris_vis2 %>%
#   filter(n_et > 0) %>%
#   dplyr::select(CandID, PSCID, ageFirstVis,Visit_label_age, Visit_label,
#                 DOB, Date_visit, cohort2,
#                 et_age, et_collected, cohort) %>%
#   mutate(CandID = as.factor(CandID),
#          # Scan status
#           status = ifelse(!is.na(et_collected), 'Visit=Yes, ET=Yes', ''), 
#           status = ifelse(!is.na(Date_visit) & is.na(et_collected), 'Visit=Yes, ET=No', status)) %>%
#   # Age for BCP-CFP
#   mutate(age2 =  Date_visit - as.Date(DOB),
#          age2 = as.numeric(age2/30),
#  Visit_label_age = ifelse(is.na(Visit_label_age), age2, Visit_label_age)) %>%
#   # BCP-CFP are feeding check-ins (not real visits )
#  mutate(remove = ifelse(cohort=='bcpCFP' & is.na(et_collected), 1, 0)) %>%
#   filter(remove ==0) %>%
#   dplyr::select(-c(cohort, remove))
```



```{r}
datatable(loris_vis2 %>%
            mutate(CandID = as.factor(CandID)) %>%
            mutate(et_collected = factor(ifelse(is.na(et_collected), 0, 1)),
                   rs_collected = factor(ifelse(is.na(rs_collected), 0, 1))) %>% 
            select(CandID, PSCID, cohort, cohort2,
                          Visit_label, Visit_label_age, VisitNo,
                          Scan_done, et_collected, rs_collected ) %>%
            arrange(CandID), 
          filter=c('top'))
```

## Tallies

### Eye-tracking

```{r}
et_indiv = et %>%
  filter(!is.na(et_collected)) %>%
  group_by(CandID) %>%
  summarize(n=n())
```

-   `r sum(et_indiv$n)` eye-tracing visits from `r nrow(et_indiv)` individuals.

```{r}
# Number of individuals in each cohort
a=et %>%
  filter(!is.na(et_collected)) %>%
  dplyr::select(CandID, cohort2) %>%
  distinct() %>%
  count(cohort2, name = 'Number of individuals')

# Numbe of visits from each cohort
b=et %>%
  filter(!is.na(et_collected)) %>%
  count(cohort2, name = 'Number of visits')

left_join(a,b, by='cohort2')
```


```{r message=FALSE,warning=FALSE}
# Add age at first visit to help w/ plotting
# loris_vis2=loris_vis2 %>%
#   group_by(CandID) %>%
#   left_join(., loris_vis2, by='CandID') %>%
#   ungroup() 
```

### Scan


```{r}
scan_tally=loris_vis2 %>%
  filter(n_scan >0) %>%
  dplyr::select(CandID, PSCID, ageFirstVis,Visit_label_age, Visit_label,
                DOB, Date_visit, Scan_done, cohort2,
                rs_collected) %>%
  mutate(CandID = as.factor(CandID),
         # Scan status
         status = ifelse(is.na(rs_collected), 'No RS', 'Has RS')) %>%
  # Age for Cross-sectional kids 
  mutate(age2 =  Date_visit - as.Date(DOB),
         age2 = as.numeric(age2/30),
 Visit_label_age = ifelse(is.na(Visit_label_age), age2, Visit_label_age))
```

```{r}
rs = scan_tally %>%
  filter(!is.na(rs_collected)) %>%
  group_by(CandID) %>%
  summarize(n=n())
```

-   `r sum(rs$n)` visits on MSI with pconns, from `r nrow(rs)` indidividuals.

```{r scan_cohort}
# Numbe of individuals in each cohort
scan_tally %>%
  filter(!is.na(rs_collected)) %>%
  dplyr::select(CandID, cohort2) %>%
  distinct() %>%
  count(cohort2, name = 'Number of individuals')

# Numbe of scans from each cohort
scan_tally %>%
  filter(!is.na(rs_collected) ) %>%
  count(cohort2, name = 'Number of scans')
```

```{r bcp_bslerp_scan_fig, cache=TRUE}
plot_dat = scan_tally %>% 
  filter(cohort2=='BSLERP') %>%
  filter(Visit_label_age!=18 & Visit_label_age!=30)

ggplot(data = plot_dat, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
  geom_point(aes(color=status), size=1.1) +
  geom_line() +
  scale_color_manual(values = c('springgreen4', 'red')) +
  theme(axis.text.y=element_blank()) + 
  scale_y_discrete()+
  scale_x_continuous(breaks = unique(plot_dat$Visit_label_age)) + 
  labs(x = 'Scan Age (months)', y = 'Individual', title='BSLERP') 
```

```{r bcp_ab_scan_fig, cache=TRUE}
plot_dat = scan_tally %>% 
  filter(cohort2=='BCP_A' | cohort2 == 'BCP_B') 

ggplot(data = plot_dat, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
  geom_point(aes(color=status), size=1.1) +
  geom_line() +
  scale_color_manual(values = c('springgreen4', 'red')) +
  theme(axis.text.y=element_blank()) + 
  scale_y_discrete()+
  scale_x_continuous(breaks = c(2, 4, 8, 10, 13, 24)) + 
  labs(x = 'Scan Age (months)', y = 'Individual', title='BCP-A, BCP-B') 
```

```{r bcp_cd_scan_fig, cache=TRUE}
plot_dat = scan_tally %>% 
  filter(cohort2=='BCP_C' | cohort2 == 'BCP_D') 

ggplot(data = plot_dat, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
  geom_point(aes(color=status), size=1.1) +
  geom_line() +
  scale_color_manual(values = c('springgreen4', 'red')) +
  theme(axis.text.y=element_blank()) + 
  scale_y_discrete()+
  #scale_x_continuous(breaks = c(2, 4, 8, 10, 13, 24)) + 
  labs(x = 'Scan Age (months)', y = 'Individual', title='BCP-C, BCP-D') 
```

```{r bcp_e_scan_fig, cache=TRUE}
plot_dat = scan_tally %>% 
  filter(cohort2=='BCP_E' | cohort2 == 'BCP_ELISON') 

ggplot(data = plot_dat, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
  geom_point(aes(color=status), size=1.1) +
  geom_line() +
  theme(axis.text.y=element_blank()) + 
  scale_color_manual(values = c('springgreen4', 'red')) +
  scale_y_discrete()+
  #scale_x_continuous(breaks = c(2, 4, 8, 10, 13, 24)) + 
  labs(x = 'Scan Age (months)', y = 'Individual', title='BCP-E') 
```


```{r bcp_clean_scan_fig, cache=TRUE}
# Figure that shows how many scans we do have 
scan_tally %>%
  filter(!is.na(rs_collected)) %>%
  filter(cohort2!='BCP_D' & cohort2!='BCP_E' & cohort2!='BCP_ELISON') %>%
    ggplot(data = ., aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
    geom_point(aes(color=cohort2), size=1.1) +
    geom_line() +
    scale_y_discrete()+
    theme(axis.text.y=element_blank()) + 
    labs(x = 'Scan Age (months)', y = 'Individual', title='Visits with .pconn on MSI') 

scan_tally %>%
  filter(!is.na(rs_collected)) %>%
  filter(cohort2=='BCP_D' | cohort2=='BCP_E' | cohort2=='BCP_ELISON') %>%
    ggplot(data = ., aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
    geom_point(aes(color=cohort2), size=1.1) +
    geom_line() +
    scale_y_discrete()+
    theme(axis.text.y=element_blank()) + 
    labs(x = 'Scan Age (months)', y = 'Individual', title='Visits with .pconn on MSI') 
```



## ET & RS  

```{r}
et_mri_tally = loris_vis2 %>% 
  filter(!is.na(rs_collected) & !is.na(et_collected)) %>%
  group_by(CandID) %>%
  summarize(n=n())
```

-   `r sum(et_mri_tally$n)` visits from `r nrow(et_mri_tally)` individuals

```{r et_and_rs_figs}
loris_vis2 %>% 
  filter(!is.na(rs_collected) & !is.na(et_collected)) %>%
  filter(cohort2!='BCP_E' & cohort2!='BCP_D') %>%
    ggplot(data = ., aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
    geom_point(aes(color=cohort2), size=1.1) +
    geom_line() +
    scale_y_discrete()+
    theme(axis.text.y=element_blank()) + 
    labs(x = 'Visit Age (months)', y = 'Individual', title='Visits with RS and ET data') 

loris_vis2 %>% 
  filter(!is.na(rs_collected) & !is.na(et_collected)) %>%
  filter(cohort2=='BCP_E' | cohort2=='BCP_D') %>%
    ggplot(data = ., aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
    geom_point(aes(color=cohort2), size=1.1) +
    geom_line() +
    scale_y_discrete()+
    theme(axis.text.y=element_blank()) + 
    labs(x = 'Visit Age (months)', y = 'Individual', title='Visits with RS and ET data') 
```



```{r}
# Make final list of participants (et, mri, et+mri)
flagged_list = loris_vis2 %>% 
  dplyr::select(CandID, PSCID, cohort, cohort2,Visit_label, VisitNo, Date_visit,
                DOB, Sex, et_collected, rs_collected) %>%
  mutate(et_flag = ifelse(!is.na(et_collected), 1, 0),
         mri_flag = ifelse(!is.na(rs_collected), 1, 0) ) %>%
  filter(et_flag==1 | mri_flag==1)

write.csv(x = flagged_list, file = paste(out_dir, 'et_or_mri.csv', sep=''), row.names = FALSE)
```


