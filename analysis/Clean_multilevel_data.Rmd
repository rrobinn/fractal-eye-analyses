---
title: "Clean data frame"
author: "Robin"
date: "02/06/2019"
output: html_document
---

```{r}
# User parameters
min_age = 0
max_age = 40
```

# Where do you want to save data?
```{r}
out_dir = '/Users/sifre002/Box/sifre002/9_ExcelSpreadsheets/Dancing_Ladies/clean_data/'
file_name = '20200803_cleaned_multilevel_data'
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
#library(readxl)
library(tidyverse)
#library(dplyr)
#library(sm)
#library(lme4)
library(ggplot2)
#library(MuMIn)
#library(bbmle)
#library(gtools)
#library(tuple)
#library(utils)
```

# Read data
```{r}
particList = read_csv(file = '/Users/sifre002/Box/sifre002/9_ExcelSpreadsheets/Dancing_Ladies/ParticipantLists_DL/20200804_particlist.csv')

h <- read_csv(file = "/Users/sifre002/Box/sifre002/7_MatFiles/01_Complexity/Individual_Data/20200803data/h_out.txt")

#precisionInfo = read.csv('/Users/sifre002/Documents/Code/fractal-eye-analyses/out/calibration_verification.csv')
precisionInfo = read.csv('/Users/sifre002/Documents/Code/fractal-eye-analyses/out/calibration_verification.csv')

CalVer <- read_excel("/Users/sifre002/Box/DancingLadiesshare/calibration-verification/Formatted_CalVerData_2018_12_12/allCalVers.xlsx")

aoi_data<- read.csv("/Users/sifre002/Box/sifre002/7_MatFiles/01_Complexity/Individual_Data/20200803data/face_out.txt")

# demographic data
# demo = read_csv('/Users/sifre002/Box/sifre002/9_ExcelSpreadsheets/09_MRI_metdata/demographic_info.csv')

# DOB (not queriable from database)
dob = read_csv('/Users/sifre002/Box/sifre002/9_ExcelSpreadsheets/09_MRI_metdata/20200408_BCP_DOB.csv')
```


<!-- # Format demograpic data  -->
<!-- ```{r} -->
<!-- source('/Users/sifre002/Documents/Code/misc/clean_loris_demographic.R') -->
<!-- demo2 = clean_demographic_data(demo) -->
<!-- # Filter for data from BCP/BSLERP -->
<!-- demo2 = demo2 %>% -->
<!--   filter(grepl('BCP|DSA_Demographics', cohort)) %>% -->
<!--   filter(!grepl('mom|Parent|Phantom', cohort)) %>% -->
<!--   mutate(cohort2=ifelse(grepl('BCP',cohort), 'BCP', 'DSA')) %>% -->
<!--   mutate(male=ifelse(sex=='Male',1,0))  -->
<!-- # Merge DOB with demographic data -->
<!-- dob = dob %>% -->
<!--   select(id=PSCID, DoB) -->
<!-- demo2 = demo2 %>% -->
<!--   left_join(dob, by = 'id') -->

<!-- setdiff(h2$Participant, demo2$id) # not in LORIS -->

<!-- ``` -->

# Format DFA output
```{r}
# Format DFA output 
h = h %>%
  # Create variable for Participant ID (currently combined with session #)
  mutate(Participant = paste(lapply(strsplit(id, '_'), '[', 1), lapply(strsplit(id, '_'), '[', 2), sep='_')) %>%
  left_join(dob, by=c('Participant'='PSCID')) %>%
  # Calculate age at time of visit 
  mutate(DoB =as.Date(DoB, format='%m/%d/%y'),
         date=as.Date(date, format='%m/%d/%Y')) %>%
  mutate(age=(date-DoB)/30.42,
         age=as.numeric(age))%>%
    # Create Dummies for CalVer & Pixelated
  mutate(CalVer=ifelse(grepl('Center|Left|Right', movie), 1, 0),
         Pix=ifelse(grepl('S', movie), 1, 0)) 

# Filter if they are not in the participant list 
h = h%>% filter(id %in% particList$id) 

# Log who was removed 
removed_h = h %>%
  dplyr::select(Participant, id) %>%
  mutate(partic_list = ifelse(id %in% particList$id, 0, 1))

```


Creates precisionInfo dataframe of average calibration XY precision information for each kid who made it through CalVer processing. 
Those with precision that is worse than threshold are coded as 999
```{r}
source('/Users/sifre002/Documents/Code/misc/clean_calver.R')
calver=clean_calver(precisionInfo)
calver_thresh=calver[[1]]
AvgPrecision=calver[[2]]
```



# Merge Precision data with H data 
```{r}
dim(h)  #14978
h2= h %>% left_join(AvgPrecision, by='id') 
# Check who is missing AvgPrecision
h2 %>% filter(is.na(AvgPrecision)) %>% dplyr::select(id) %>% unique()

  filter(!is.na(AvgPrecision) & AvgPrecision!=999) %>%#999=bad precision, NA=missing
  filter(propInterp<quantile(propInterp, .8))


```


# Filter out bad segments 
```{r}

removed_precision = h2 %>%
  left_join(AvgPrecision, by = 'id') %>%
  mutate(removed_precision = ifelse(is.na(AvgPrecision) | AvgPrecision ==999, 1, 0) ,
         removed_propInterp = ifelse(propInterp>=quantile(propInterp,.8),1,0)) %>%
  dplyr::select(id,movie,seg,removed_precision, removed_propInterp) %>%
  filter(removed_precision==1 | removed_propInterp==1)

removed_h = removed_h %>%
  left_join(removed_precision, by = c('id','movie','seg')) %>%
  filter(id %in% particList$id)

h2 = h %>%
  # If time series was too short, remove from sample
  filter(warning==0) %>%
  # filter for age range
  filter(age>min_age & age<max_age) 

# Info on which trials were removed
removed_h=h %>%
  dplyr::select(Participant,id,movie,seg,propInterp,warning,age)%>%
  mutate(removed_tooshort=ifelse(warning==1,1,0),
         removed_age=ifelse(age<min_age|age>max_age,1,0),
         removed_particList = ifelse(!id %in% particList$id, 1,0)) %>%
  dplyr::select(-c(warning,age)) %>%
  filter(removed_tooshort==1|removed_age==1) 

# sanity
test = h2 %>% group_by(id) %>% summarise(n=n())
```


# flow on removal
```{r}
# How much data we started with 
start_id = h %>%filter(id %in% particList$id) %>%dplyr::select(Participant) %>% unique() %>% nrow()
start_sess = h %>%filter(id %in% particList$id) %>%dplyr::select(id) %>% unique() %>% nrow()
start_seg = h %>%filter(id %in% particList$id) %>% nrow()

# Outside of age-range
removed_age = removed_h %>%
  filter(removed_age == 1) %>%
  summarize(n_partic = length(unique(Participant)),
            n_sess = length(unique(id)),
            n_seg = length(unique(seg))) 

# Remove for precision 

# Removed for times series too short 
removed_propinterp = removed_h %>%
  filter(removed_age ==0) %>% # Don't double-count those removed for being outside of age-range
  summarize(n_partic = length(unique(Participant)),
            n_sess = length(unique(id)),
            n_seg = length(unique(seg))) 


# Removed for too much interpolated 
removed_propinterp = removed_h %>%
  filter(removed_age ==0) %>% # Don't double-count those removed for being outside of age-range
  filter(removed_tooshort == 1) %>%
  summarize(n_partic = length(unique(Participant)),
            n_sess = length(unique(id)),
            n_seg = length(unique(seg))) 




```



```{r}
test =h3 %>%
  group_by(id) %>%
  summarize(n=n())
min(test$n)
max(test$n)
mean(test$n)
```

# Clean AOI data
```{r}
aoi_data2 = aoi_data %>%
  filter(longestFixDur!=-9999) %>%
  dplyr::select(id,
          movie,
          seg,
          longestFix_aoi = longestFixDur,
          faceCount, otherCount) %>%
  mutate(id=as.character(id),
         movie=as.character(movie))
```

# Merge AOI data with H data 
```{r}
h4 = h3 %>%
  left_join(aoi_data2, by = c('id', 'movie', 'seg')) %>%
  mutate(propFace_seg = faceCount / (faceCount + otherCount))
```





Merge aoi data with master_longit
```{r}
# Master_longit = Master3 %>%
#   dplyr::select(ID, Participant, LongestFixDuration, PropInterp, PropMissing, PrecisionRMS_X_Y,Amplitude, H, SpectWidth, Age, MovieName, Seg, Stimulus, Version, Pixelated, NonPixelated, Calver, Stimulus,Sex, female, cohort_dummy)
# temp1 = Master_longit %>% filter(Stimulus=='DL') # only movie trials
# temp2 = Master_longit %>% filter(Stimulus=='C') # only CalVer trials
# 
# test =merge(temp1, aoi_data2, by = c('ID', 'MovieName', 'Seg'))
# test$propFace_seg = test$faceCount / (test$faceCount + test$otherCount)
# 
# temp2$longestFix_aoi = NA
# temp2$faceCount = NA
# temp2$otherCount = NA
# temp2$propFace_seg = NA
# 
# Master_longit2 = rbind(test, temp2)
```


# Create person-, visit-, and movie-centered variables. These are used to parse variance for modelling.
```{r}
# Get grand mean for average age
AveAge = Master_longit2 %>%
  group_by(ID)%>%
  summarise(Age = unique(Age)) %>%
  summarise(Age = mean(Age) )

# Get grand mean for average longest fix
aveLongFix=mean(Master_longit2$LongestFixDuration)
AveAge = Master_longit2 %>%
  group_by(ID) %>%
  summarise(age = mean(Age))
AveAge = mean(AveAge$age)
#avePrec=mean(Master_longit2$PrecisionRMS_X_Y)
#avePropFace = mean(Master_longit2$propFace_seg, na.rm = TRUE)

#
Master_longit2=Master_longit2%>%
  mutate(Age_centeredGrandmean=as.numeric(Age-AveAge),
         longestFix_seg_centeredGrandmean = as.numeric(LongestFixDuration - aveLongFix))

# Creating level 3 (person) variables:
# Average age: Participant's average age, centered on grand mean
# Average Interpolated: mean prop interp
# Average precision: mean precision (weight each visit once)
# Average longest fix: mean longest fix, centered on grand mean 
# Average face looking: NEED TO ADD THIS 
personLevel_var=Master_longit2%>%
  group_by(Participant)%>%
  summarise(AveAge_person=mean(unique(Age_centeredGrandmean)), 
            AveInterp_person=mean(PropInterp),
            AveMissing_person=mean(PropMissing),
            AvePrecision_person = mean(PrecisionRMS_X_Y),
            AveLongestFix_person=mean(LongestFixDuration),
            AvePropFace_person = sum(faceCount, na.rm = TRUE) / ( sum(faceCount, na.rm = TRUE) + sum(otherCount, na.rm = TRUE) ),
            n_person=n())

# Session age = Age_centeredGrandmean (no within-session variability)
# Average interpolated: Mean prop interp, for the session
# Average Missing: Mean prop Missing
# Average longest fix: mean longest fix, centered on grand mean
# Average face looking: mean face looking for the session 
sessionLevel_var = Master_longit2 %>%
  group_by(ID) %>%
  summarise(AveInterp_session = mean(PropInterp),
            AveMissing_session = mean(PropMissing), 
            AveLongestFix_session = mean(longestFix_seg_centeredGrandmean),
            AvePropFace_session = sum(faceCount, na.rm = TRUE) / ( sum(faceCount, na.rm = TRUE) + sum(otherCount, na.rm = TRUE) ))


movieLevel_var = Master_longit2 %>%
  group_by(Participant, ID, MovieName) %>%
  summarise(AveInterp_movie = mean(PropInterp),
            AveMissing_movie = mean(PropMissing), 
            AveLongestFix_movie = mean(longestFix_seg_centeredGrandmean),
            AvePropFace_movie = sum(faceCount, na.rm = TRUE) / ( sum(faceCount, na.rm = TRUE) + sum(otherCount, na.rm = TRUE) ))

# Merge person-level
Master_longit3 = merge(Master_longit2, personLevel_var, by = 'Participant')
# Merge visit-level
Master_longit4 = merge(Master_longit3, sessionLevel_var, by = 'ID')
# Merge movie-level
Master_longit5 = merge(Master_longit4, movieLevel_var, by = c('Participant', 'ID', 'MovieName'))
# Create SEGMENT-LEVEL VARIABLES centered at MOVIE LEVEL
Master_longit5$propInterp_segment_groupmeancentered = Master_longit5$PropInterp - Master_longit5$AveInterp_movie
Master_longit5$longestFix_segment_groupmeancentered = Master_longit5$longestFix_seg_centeredGrandmean - Master_longit5$AveLongestFix_movie
Master_longit5$propFace_segment_groupmeancentered = Master_longit5$propFace_seg - Master_longit5$AvePropFace_movie

# Create MOVIE-LEVEL VARIABLES centered at VISIT-LEVEL
Master_longit5$propInterp_movie_groupmeancentered = Master_longit5$AveInterp_movie - Master_longit5$AveInterp_session
Master_longit5$longestFix_movie_groupmeancentered = Master_longit5$AveLongestFix_movie - Master_longit5$AveLongestFix_session
Master_longit5$propFace_movie_groupmeancentered = Master_longit5$AvePropFace_movie - Master_longit5$AvePropFace_session

# Create VISIT-LEVEL variables centered at PERSON-LEVEL
Master_longit5$propInterp_session_groupmeancentered = Master_longit5$AveInterp_session - Master_longit5$AveInterp_person
Master_longit5$longestFix_session_groupmeancentered = Master_longit5$AveLongestFix_session - Master_longit5$AveLongestFix_person
Master_longit5$propFace_session_groupmeancentered = Master_longit5$AvePropFace_session - Master_longit5$AvePropFace_person
Master_longit5$precision_session_groupmeancentered = Master_longit5$PrecisionRMS_X_Y - Master_longit5$AvePrecision_person

# Create PERSON_LEVEL variables centered at GRAND MEAN
Master_longit5$propInterp_person_grandmeancentered = Master_longit5$AveInterp_person - mean(Master_longit5$PropInterp)
Master_longit5$longestFix_person_grandmeancentered  = Master_longit5$AveLongestFix_person - mean(Master_longit5$AveLongestFix_person)
Master_longit5$propFace_person_grandmeancentered  = Master_longit5$AvePropFace_person - mean(Master_longit5$propFace_seg, na.rm = TRUE)
Master_longit5$precision_person_grandmeancentered  = Master_longit5$AvePrecision_person - mean(Master_longit5$PrecisionRMS_X_Y, na.rm=TRUE)

############################################################################
#Commented out code - could be useful or reporting 

#Finds participant info
# Master_longit_sample=Master_longit4%>%
#   group_by(Participant, ID)%>%
#   summarise(n=n(),
#             female=mean(as.numeric(female, na.rm=TRUE)))
# Master_longit_female=Master_longit4%>%
#   filter(female==1)%>%
#   group_by(Participant)%>%
#   summarise(n=n())

# N_female=unique(Master_longit_female$Participant)
# mean(Master_longit$PropMissing, na.rm=TRUE)

# #Finds time pts per kid
# library(tuple)
# Master_longit_sum=Master_longit%>%
#   group_by(Participant, ID)%>%
#   summarize(n())%>%
#   mutate(dummy=1)%>%
#          # dup=duplicated(Participant),
#          # trip=triplicated(Participant))%>%
#   group_by(Participant)%>%
#   summarize(sessions=sum(dummy))

```




