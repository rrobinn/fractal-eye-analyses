---
title: "R Notebook"
output:
  rmdformats::readthedown:
    highlight: kate
    self_contained: true
---

```{r warning=FALSE, comment = FALSE, message = FALSE, echo = FALSE}
library(tidyverse)
library(ggplot2)
library(knitr)
library(readxl)
library(DT)
library(miceadds)

wdir = '~/Documents/Github/fractal-eye-analyses/'
options(max.print="75")
opts_chunk$set(echo=FALSE,
               cache=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               include=TRUE)

source.all(paste(wdir, 'analysis/Rfuncs/', sep =''))
```

# About  
Document generates a list of visits to be included in my dissertation.  

```{r echo = TRUE}
# Directory where each session has its own sub-directory (excluding sessions that were in MS)
data_dir = '~/Box/sifre002/7_MatFiles/01_Complexity/Individual_Data/20201112data/New_Sessions/'
# 
pconn_file = '~/Documents/GitHub/enrichment-repetitive-bx/Marginal-Model-Data/listofpconns.txt'
```
- `data_dir`: Location of <b>eye-tracking data</b> (.tsv and .mat files). If a .tsv in `~/Box/Elab_ET_Data/BCP_BSLERP/AUDIT_PASSED` contains the strings 'CalVer', 'Dancing', 'EU', or 'DL', it will end up with its own subdirectory in `~/AUDIT_PASSED/`.  
- `pconn_file`: List of directories w/ RS .pconn files.  

<b>Path where final list will be stored:</b>
```{r}
listname = 'Dissertation_ParticList.csv'
out_dir = paste(wdir, 'data/', listname, sep ='')
out_dir
```

```{r}
loris_vis <- list_of_visits(path_to_session_query = '~/Documents/GitHub/fractal-eye-analyses/data/misc_queries/visit_list.txt', 
                           path_to_bcpVisitOrder_query = '~/Documents/GitHub/fractal-eye-analyses/data/misc_queries/BCP_info.txt') 

# Remove babar
loris_vis = loris_vis %>%
  filter(!grepl('babar', cohort))
```

```{r}
# Pull Individual-level data 
# (CandID,PSCID,cohort,DOB,Sex)
# # # # # # # # # # # # # # # # 
indiv_dat = loris_vis %>% 
  dplyr::select(CandID,  PSCID, cohort,DOB, Sex) %>% 
  filter(!grepl('babar', cohort)) %>%
  distinct() %>%
  # For now, remove all rows w/o DOB 
  mutate(to_remove = ifelse(is.na(DOB), 1, 0))

removed_from_indiv_dat = indiv_dat %>% 
  filter(to_remove==1) 
indiv_dat = indiv_dat %>% filter(to_remove==0) 

# Some individuals have multiple cohorts - select the one that says BCP 
cohort=indiv_dat %>% group_by(CandID) %>%
  arrange(CandID) %>%
  group_by(CandID) %>% 
  mutate(r = row_number()) %>%
  mutate(r = paste('r',r,sep='')) %>%
  spread(., r, cohort) %>%
  # Flag which cohort to use 
  # IF there is only 1, use that one 
  mutate(flag = ifelse(is.na(r2) & is.na(r3), 1, NA),
         # If there is more than one cohort, but the first one is not cross-sectional, then use the first 
         flag = ifelse(is.na(flag) & !grepl('CFP|ELISON', r1), 1, flag),
         flag = ifelse(is.na(flag) & !grepl('CFP|ELISON', r2), 2, flag),
         flag = ifelse(is.na(flag) & is.na(r3), 2, flag)) %>%
  ungroup() %>%
    mutate(cohort = ifelse(flag==1, r1, NA),
         cohort = ifelse(flag==2, r2, cohort),
         cohort = ifelse(flag==3, r3, cohort)) %>%
  dplyr::select(CandID, cohort)

# Update cohort with the correct one to use (should be 585 rows)
indiv_dat= left_join(indiv_dat, cohort, by = c('CandID')) %>%
  mutate(cohort2 = cohort.y) %>% 
  dplyr::select(-c(cohort.x, cohort.y)) %>%
  distinct()
```

```{r clean_cohort}

# Clean up cohort
loris_vis = loris_vis %>%
  left_join(indiv_dat %>% dplyr::select(CandID, cohort2), by = 'CandID') %>%
mutate(cohort2 = ifelse(grepl(pattern = 'bcpBSLERP', x = cohort2, ignore.case = TRUE), 'BSLERP', cohort2), 
  cohort2 = ifelse(grepl(pattern = 'BCPA', x = cohort2, ignore.case = TRUE), 'BCP_A', cohort2),
         cohort2 = ifelse(grepl(pattern = 'BCPB', x = cohort2, ignore.case = TRUE), 'BCP_B', cohort2),
         cohort2 = ifelse(grepl(pattern = 'BCPC', x = cohort2, ignore.case = TRUE), 'BCP_C', cohort2),
         cohort2 = ifelse(grepl(pattern = 'BCPD', x = cohort2, ignore.case = TRUE), 'BCP_D', cohort2),
         cohort2 = ifelse(grepl(pattern = 'BCPELISON', x = cohort2, ignore.case = TRUE), 'BCP_ELISON', cohort2),
         cohort2 = ifelse(grepl(pattern = 'BCPE', x = cohort2, ignore.case = TRUE) & cohort2!='BCP_ELISON', 'BCP_E', cohort2),
         cohort2 = ifelse(grepl(pattern = 'BSLERP', x = cohort2, ignore.case = TRUE), 'BSLERP', cohort2),
         cohort2 = ifelse(grepl(pattern = 'DSA', x = cohort2, ignore.case = TRUE), 'other', cohort2)) %>%
  # Pull visit_label_age
  mutate(Visit_label_age = lapply(strsplit(Visit_label, 'x'), '[', 2),
         Visit_label_age = unlist(Visit_label_age),
         Visit_label_age = gsub(pattern = 'm', replacement = '', Visit_label_age),
         Visit_label_age = ifelse(Visit_label_age == 'Birth2wk', "0.5", Visit_label_age),
         Visit_label_age = as.numeric(Visit_label_age)) 
  
```


# Steps for getting list of ET data  
0. Use session table from LORIS to get list of visits for each participant (`list_of_visits.R`). Use this generate `indiv-dat` (DOB, cohort, sex).
1. Get date of visit for newly-processed .tsv files  
2. Merge `indiv_dat`. Calculate age at visit.  
3. For eachc potential visit in `loris_vis` find the closest matching eye-tracking visit that occurred (if at all. )

```{r getDateOfVisitFromTobii, cache = TRUE}
## Get date of visit from tobii .tsv
files = list.dirs(data_dir)
# Get date of scan for calculating DOBs from raw tobii file
ids = c()
date_of_vis = c()

for (f in files){
  ids = c(ids, basename(f))
  date_of_vis = c(date_of_vis, get_date_et(f))
}

# Years are not entered in consistent way - fix this. 
date_of_vis = unlist(date_of_vis)
date_split = strsplit(date_of_vis, '/')

# Data.frame to store visit dates 
visit_dates = data.frame(session = ids, 
                         date = as.character(date_of_vis),
                         year = unlist(lapply(date_split, '[', 3)),
                         month = unlist(lapply(date_split, '[', 1)) ,
                         day = unlist(lapply(date_split, '[', 2) ))

# Format visit date 
visit_dates = visit_dates %>%
  mutate(session = as.character(session)) %>%
  mutate(PSCID = paste(lapply(strsplit(session, '_'), '[[', 1),
                       lapply(strsplit(session, '_'), '[[', 2), sep = '_') ) %>%
  # Fix years
  mutate(year = as.numeric(as.character(year)),
         year = year%%2000,
         year = year + 2000) %>%
  mutate(month = as.numeric(as.character(month)),
         day = as.numeric(as.character(day))) %>%
  mutate(visit_date = paste(year,month,day, sep = '-')) %>%
  # get rid of first row
  filter(session!='New_Sessions') %>%
  dplyr::select(PSCID, session,visit_date)
```

```{r crosscheck_ms}
# Data from ms (to see who we already have)
# List of id_sessions & their ages to include to analyses (DOB is identifying info) 
particList = read_csv(file = paste(wdir, 'data/participantList.csv', sep = ''))

# Concatenated output Output from pipeline in fractal-eye-analyses-MFDFA/
h <- read_csv(file = paste(wdir, 'data/h_out.txt', sep = ''))

h = h %>%
  # Create variable for Participant ID (currently combined with session #)
  mutate(Participant = paste(lapply(strsplit(id, '_'), '[', 1), lapply(strsplit(id, '_'), '[', 2), sep='_')) %>%
  left_join(particList, by='id') %>%
  # Variable to keep track of if theyre in participant list
  mutate(particList = ifelse(id %in% particList$id, 1, 0))

old_data = h %>% 
  dplyr::select(session=id, date, PSCID = Participant, age) %>%
  distinct()
```


```{r}
# Merge individual-level data with visit_dates 
visit_dates = visit_dates %>% 
  left_join(indiv_dat, by = 'PSCID') %>%
    mutate(age = as.Date(visit_date) - as.Date(DOB),
           age = as.numeric(age),
           age = age/30.42)

# Make date for old_data y-m-d
d=strsplit(old_data$date, '/')
month = unlist(lapply(d, '[[', 1))
day =  unlist(lapply(d, '[[', 2))
year = unlist(lapply(d, '[[', 3))
old_data$date = paste(year, month, day, sep = '-' )

# Merge individual-level data w/ old data & calculate age 
old_data = old_data %>%
  dplyr::select(PSCID, session, visit_date = date, age) %>%
  left_join(indiv_dat, by = 'PSCID') %>%
  # Fix DOB
  mutate(age = as.Date(visit_date) -  as.Date(DOB),
         age = as.numeric(age)/30.42)
  

# Combine old & new visits 
et_visits = rbind(visit_dates %>% mutate(batch = 'New'), 
                  old_data %>% mutate(batch = 'Old')) %>% 
  mutate(visit_date = as.Date(visit_date)) %>%
  arrange(PSCID)
```

## Check who we are missing info for  
`et_visits`: list of eye-tracking visits from `data_dir` and spreadsheet that has the data that were potentially included in *Scientific Reports* ms.  
```{r echo = TRUE}
et_visits %>% filter(is.na(PSCID) | is.na(CandID) | is.na(DOB) | is.na(Sex))
```
Looks like DSA individuals in LORIS with no visits registered yet.  

## Merge eye tracking data with loris_vis
```{r find_closest_et_vis}
# For each eye-tracking visit, find closest visit in loris_vis and add flag
loris_vis$Date_visit = as.Date(loris_vis$Date_visit)
loris_vis$et_collected = NA
loris_vis$et_age = NA

for (i in c(1:nrow(et_visits))) {
  temp = et_visits[i,]
  # Find closest date
  date_array = loris_vis %>% 
    filter(PSCID == temp$PSCID) %>%
    pull(Date_visit) %>%
  as.Date()
  
   closest_ind = which.min(as.numeric(abs(date_array - temp$visit_date)))
   closest_date = date_array[closest_ind]
  
   loris_vis[compareNA(loris_vis$Date_visit, closest_date) & loris_vis$PSCID == temp$PSCID, 'et_collected'] = temp$session
        loris_vis[compareNA(loris_vis$Date_visit, closest_date) & loris_vis$PSCID == temp$PSCID, 'et_age'] = temp$age
  }
```


# Steps for getting list of RS data
## 1. Read .pconn file (contains paths to all .pconns)
```{r pconns_mesabi}
# Directories on mesabi
listofpconns <- read.table(pconn_file, quote="\"", comment.char="", stringsAsFactors = FALSE)

listofpconns = listofpconns %>%
  dplyr::select(fname = V1, exists=V2) %>%
  # remove file names that arent sub-123456_ses-XXmo_corr
  filter(grepl('sub-', fname)) %>%
  mutate(id_nums = gsub("\\D+", "", fname),
         CandID = substring(id_nums, 1, 6),
         vis = as.numeric(id_nums)%%as.numeric(CandID),
         CandID = as.numeric(CandID)) %>%
  dplyr::select(-c(id_nums)) %>%
  # Get rid of duplicates (m_corr vs mo_corr)
  mutate(fname = gsub(x = fname, pattern = 'mo', replacement='m')) %>%
  distinct()

datatable(listofpconns, colnames=c('Directory name', '.pconn exists/missing', 'CandID', 'Visit'), filter='top')
```

Visits with/without .pconn
```{r}
count(listofpconns, exists)
```

## 2. Merge whether scan happened with loris_vis
```{r}
loris_vis$rs_collected = NA
loris_vis$pconn_exists = NA

# For every visit in list of pconns
for (i in 1:nrow(listofpconns)) {
  temp = listofpconns[i, ]
  id = temp$CandID
  age= temp$vis
  
  # Pull all visits for this CandID
  vis = loris_vis %>% 
    filter(CandID == id) %>%
    mutate(temp_age = Date_visit - as.Date(DOB),
            temp_age = as.numeric(temp_age)/30.42)
  
  # If there is an exact visit age match 
  if (age %in% vis$Visit_label_age) {
    closest_age = age
    loris_vis[compareNA(id, loris_vis$CandID) & compareNA(age, loris_vis$Visit_label_age), 'rs_collected'] = temp$fname
    loris_vis[compareNA(id, loris_vis$CandID) & compareNA(age, loris_vis$Visit_label_age), 'pconn_exists'] = temp$exists
  } else { 
    # Otherwise, find the closest one
    min_ind = which.min(abs(vis$temp_age - age))
    closest_vis = vis[min_ind, 'Visit_label']
    loris_vis[compareNA(id, loris_vis$CandID) & loris_vis$Visit_label == closest_vis, 'rs_collected'] = temp$fname
    loris_vis[compareNA(id, loris_vis$CandID) & loris_vis$Visit_label == closest_vis, 'pconn_exists'] = temp$exists
  }
}
  
```

```{r}
# old_data = old_data %>%
#   mutate(Cohort2 = ifelse(grepl(pattern = 'BSLERP', x = Cohort), 'BSLERP', Cohort),
#          Cohort2 = ifelse(grepl(pattern = 'DevSocAtt', x = Cohort), 'Other', Cohort2),
#          Cohort2 = ifelse(grepl(pattern = 'ELISON', x = Cohort), 'BSLERP', Cohort2),
#          Cohort2 = ifelse(grepl(pattern = 'E1', x = Cohort), 'BCP_E', Cohort2),
#          Cohort2 = ifelse(grepl(pattern = 'A2', x = Cohort) | 
#                             grepl(pattern = 'A3', x = Cohort) , 'BCP_A', Cohort2),
#          Cohort2 = ifelse(grepl(pattern = 'B1', x = Cohort) |
#                             grepl(pattern = 'B2', x = Cohort) |
#                             grepl(pattern = 'B3', x = Cohort), 'BCP_B', Cohort2),
#          Cohort2 = ifelse(grepl(pattern = 'C1', x = Cohort) |
#                             grepl(pattern = 'C2', x = Cohort) |
#                             grepl(pattern = 'C3', x = Cohort), 'BCP_C', Cohort2),
#          Cohort2 = ifelse(grepl(pattern = 'D1', x = Cohort) |
#                             grepl(pattern = 'D2', x = Cohort) |
#                             grepl(pattern = 'D3', x = Cohort), 'BCP_D', Cohort2)) 
```




# Final
```{r}
# Determine who has at least one scan OR one et visit
et_scan_flag = loris_vis %>%
  group_by(CandID) %>%
  summarize(n_et = sum(!is.na(et_collected)),
            n_scan = sum(!is.na(rs_collected)) ) %>%
  ungroup()

# Only keep CandIDs that have at least one scan or one et visit 
loris_vis2 = loris_vis %>%
  left_join(et_scan_flag, by = 'CandID') %>%
  filter(n_et>0 | n_scan>0)

```


```{r}
datatable(loris_vis2 %>%
            mutate(CandID = as.factor(CandID)) %>%
            dplyr::select(CandID, PSCID, cohort, cohort2,
                          Visit_label, Visit_label_age, VisitNo,
                          Scan_done, et_collected, rs_collected,pconn_exists ), 
          filter=c('top'))
```

## Tallies
```{r message=FALSE,warning=FALSE}
# Add age at first visit to help w/ plotting
loris_vis2=loris_vis2 %>%
  group_by(CandID) %>%
  # Add number of visits (n), and ageFirstVis
  summarise(ageFirstVis = min(Visit_label_age, na.rm = TRUE)) %>%
  left_join(., loris_vis2, by='CandID') %>%
  ungroup() 
```

### Scan
```{r}
scan_tally=loris_vis2 %>%
  filter(n_scan >0) %>%
  dplyr::select(CandID, PSCID, ageFirstVis,Visit_label_age, Visit_label,
                DOB, Date_visit, Scan_done, cohort2,
                rs_collected, pconn_exists) %>%
  mutate(CandID = as.factor(CandID),
         # Scan status
         status = ifelse(is.na(rs_collected), 'No RS Dir', ''),
         status = ifelse(compareNA(pconn_exists, 'missing'), 'RS Dir', status),
         status = ifelse(compareNA(pconn_exists, 'exists'), 'RS Dir + pconn', status)) %>%
  # Age for Cross-sectional kids 
  mutate(age2 =  Date_visit - as.Date(DOB),
         age2 = as.numeric(age2/30),
 Visit_label_age = ifelse(is.na(Visit_label_age), age2, Visit_label_age))
```

```{r}
rs = scan_tally %>%
  filter(!is.na(rs_collected)) %>%
  group_by(CandID) %>%
  summarize(n=n())

rs_and_pconn = scan_tally %>%
  filter(!is.na(rs_collected) & compareNA(pconn_exists, 'exists')) %>%
  group_by(CandID) %>%
  summarize(n=n())
```
- `r sum(rs_and_pconn$n)` visits on MSI with pconns, from `r nrow(rs_and_pconn)` indidividuals.  

```{r scan_cohort}
# Numbe of individuals in each cohort
scan_tally %>%
  filter(!is.na(rs_collected) & compareNA(pconn_exists, 'exists')) %>%
  dplyr::select(CandID, cohort2) %>%
  distinct() %>%
  count(cohort2, name = 'Number of individuals')

# Numbe of scans from each cohort
scan_tally %>%
  filter(!is.na(rs_collected) & compareNA(pconn_exists, 'exists')) %>%
  count(cohort2, name = 'Number of scans')
```



```{r bcp_bslerp_scan_fig, cache=TRUE}
plot_dat = scan_tally %>% 
  filter(cohort2=='BSLERP') %>%
  filter(Visit_label_age!=18 & Visit_label_age!=30)

ggplot(data = plot_dat, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
  geom_point(aes(color=status), size=1.1) +
  geom_line() +
  scale_color_manual(values = c('red', 'black', 'springgreen4')) +
  theme(axis.text.y=element_blank()) + 
  scale_y_discrete()+
  scale_x_continuous(breaks = unique(plot_dat$Visit_label_age)) + 
  labs(x = 'Scan Age (months)', y = 'Individual', title='BSLERP') 
```

```{r bcp_ab_scan_fig, cache=TRUE}
plot_dat = scan_tally %>% 
  filter(cohort2=='BCP_A' | cohort2 == 'BCP_B') 

ggplot(data = plot_dat, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
  geom_point(aes(color=status), size=1.1) +
  geom_line() +
  scale_color_manual(values = c('red', 'black', 'springgreen4')) +
  theme(axis.text.y=element_blank()) + 
  scale_y_discrete()+
  scale_x_continuous(breaks = c(2, 4, 8, 10, 13, 24)) + 
  labs(x = 'Scan Age (months)', y = 'Individual', title='BCP-A, BCP-B') 
```

```{r bcp_cd_scan_fig, cache=TRUE}
plot_dat = scan_tally %>% 
  filter(cohort2=='BCP_C' | cohort2 == 'BCP_D') 

ggplot(data = plot_dat, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
  geom_point(aes(color=status), size=1.1) +
  geom_line() +
  scale_color_manual(values = c('red', 'black', 'springgreen4')) +
  theme(axis.text.y=element_blank()) + 
  scale_y_discrete()+
  #scale_x_continuous(breaks = c(2, 4, 8, 10, 13, 24)) + 
  labs(x = 'Scan Age (months)', y = 'Individual', title='BCP-C, BCP-D') 
```

```{r bcp_e_scan_fig, cache=TRUE}
plot_dat = scan_tally %>% 
  filter(cohort2=='BCP_E' | cohort2 == 'BCP_ELISON') 

ggplot(data = plot_dat, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
  geom_point(aes(color=status), size=1.1) +
  geom_line() +
  theme(axis.text.y=element_blank()) + 
  scale_color_manual(values = c('red', 'black', 'springgreen4')) +
  scale_y_discrete()+
  #scale_x_continuous(breaks = c(2, 4, 8, 10, 13, 24)) + 
  labs(x = 'Scan Age (months)', y = 'Individual', title='BCP-E') 
```


```{r bcp_clean_scan_fig, cache=TRUE}
# Figure that shows how many scans we do have 
scan_tally %>%
  filter(!is.na(rs_collected)) %>%
  filter(compareNA(pconn_exists, 'exists')) %>%
  filter(cohort2!='BCP_D' & cohort2!='BCP_E' & cohort2!='BCP_ELISON') %>%
    ggplot(data = ., aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
    geom_point(aes(color=cohort2), size=1.1) +
    geom_line() +
    scale_y_discrete()+
    theme(axis.text.y=element_blank()) + 
    labs(x = 'Scan Age (months)', y = 'Individual', title='Visits with .pconn on MSI') 

scan_tally %>%
  filter(!is.na(rs_collected)) %>%
  filter(compareNA(pconn_exists, 'exists')) %>%
  filter(cohort2=='BCP_D' | cohort2=='BCP_E' | cohort2=='BCP_ELISON') %>%
    ggplot(data = ., aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
    geom_point(aes(color=cohort2), size=1.1) +
    geom_line() +
    scale_y_discrete()+
    theme(axis.text.y=element_blank()) + 
    labs(x = 'Scan Age (months)', y = 'Individual', title='Visits with .pconn on MSI') 
```


## Eye-tracking
```{r}
et=loris_vis2 %>%
  filter(n_et >0,
         !is.na(Visit_label)) %>%
  dplyr::select(CandID, PSCID, ageFirstVis,Visit_label_age, Visit_label,
                DOB, Date_visit, cohort2,
                et_age, et_collected) %>%
  mutate(CandID = as.factor(CandID),
         # Scan status
          status = ifelse(!is.na(et_collected), 'Visit=Yes, ET=Yes', ''), 
          status = ifelse(is.na(Date_visit), 'Visit=No', status),
          status = ifelse(!is.na(Date_visit) & is.na(et_collected), 'Visit=Yes, ET=No', status)) %>%
  # Age for Cross-sectional kids 
  mutate(age2 =  Date_visit - as.Date(DOB),
         age2 = as.numeric(age2/30),
 Visit_label_age = ifelse(is.na(Visit_label_age), age2, Visit_label_age)) 
```

```{r}
et_indiv = et %>%
  filter(!is.na(et_collected)) %>%
  group_by(CandID) %>%
  summarize(n=n())
```
- `r sum(et_indiv$n)` eye-tracing visits from `r nrow(et_indiv)` individuals. 

```{r}
# Numbe of individuals in each cohort
et %>%
  filter(!is.na(et_collected)) %>%
  dplyr::select(CandID, cohort2) %>%
  distinct() %>%
  count(cohort2, name = 'Number of individuals')

# Numbe of individuals from each cohort
et %>%
  filter(!is.na(et_collected)) %>%
  count(cohort2, name = 'Number of visit')
```

```{r et_bslerp_fig, cache=TRUE, fig.width=12, fig.height=10}
plot_dat1 = et %>% 
  filter(cohort2=='BSLERP')  %>%
  filter(Visit_label_age!=18,
         ageFirstVis < 5)

plot_dat2 = et %>% 
  filter(cohort2=='BSLERP')  %>%
  filter(Visit_label_age!=18,
         ageFirstVis >= 5)

ggplot(data = plot_dat1, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
  geom_point(aes(color=status), size=1.1) +
  geom_line() +
  scale_color_manual(values = c('black', 'red', 'springgreen4')) +
  scale_x_continuous(breaks = c(3, 4, 6, 7, 9, 10, 12, 13, 24, 30, 36))+
  scale_y_discrete()+
  labs(x = 'ET Age (months)', y = 'Individual', title='BSLERP - 1') 

ggplot(data = plot_dat2, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
  geom_point(aes(color=status), size=1.1) +
  geom_line() +
  scale_color_manual(values = c('black', 'red', 'springgreen4')) +
  scale_x_continuous(breaks = c(5,8, 11, 14,24, 30, 36))+
  scale_y_discrete()+
  labs(x = 'ET Age (months)', y = 'Individual', title='BSLERP - 2') 

```

```{r etfig_bcpab, fig.width = 12,fig.height = 10}
plot_dat = et %>% 
filter(cohort2=='BCP_A' | cohort2 == 'BCP_B') 


ggplot(data = plot_dat, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
  geom_point(aes(color=status), size=1.1) +
  geom_line() +
  scale_color_manual(values = c('black', 'red', 'springgreen4')) +
  scale_x_continuous(breaks = c(2, 4, 8, 10, 13, 24)) + 
  scale_y_discrete()+
  labs(x = 'ET Age (months)', y = 'Individual', title='BCP-A, BCP-B') 
```

```{r etfig_bcpcd, fig.width = 12,fig.height = 10}
plot_dat = et %>% 
filter(cohort2=='BCP_C' | cohort2 == 'BCP_D') 

ggplot(data = plot_dat, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
  geom_point(aes(color=status), size=1.1) +
  geom_line() +
  scale_color_manual(values = c('black', 'red', 'springgreen4')) +
  scale_x_continuous(breaks = c(2, 4, 8, 10, 13, 24)) + 
  scale_y_discrete()+
  labs(x = 'ET Age (months)', y = 'Individual', title='BCP-C, BCP-D') 
```

```{r etfig_bcp_e, fig.width = 12,fig.height = 10, cache=TRUE}
plot_dat = et %>% 
filter(cohort2=='BCP_E' | cohort2 == 'BCP_ELISON') 

ggplot(data = plot_dat, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
  geom_point(aes(color=status), size=1.1) +
  geom_line() +
  scale_color_manual(values = c('black', 'red', 'springgreen4')) +
  scale_x_continuous(breaks = c(2, 4, 8, 10, 13, 24)) + 
  scale_y_discrete()+
  labs(x = 'ET Age (months)', y = 'Individual', title='BCP-E, BCP-ELISON') 
```

```{r etfig_other, fig.width = 12,fig.height = 10, cache=TRUE}
plot_dat = et %>% 
filter(cohort2=='other' | cohort2 == 'ift') 

ggplot(data = plot_dat, aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
  geom_point(aes(color=status), size=1.1) +
  geom_line() +
  scale_x_continuous(breaks = c(2, 4, 8, 10, 13, 24)) + 
  scale_y_discrete()+
  labs(x = 'ET Age (months)', y = 'Individual', title='IFT, DSA') 
```

```{r clean_et}
et %>%
  filter(!is.na(et_collected)) %>%
  filter(cohort2=='BCP_A' | cohort2=='BCP_B' | cohort2=='BCP_C') %>%
    ggplot(data = ., aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
    geom_point(aes(color=cohort2), size=1.1) +
    geom_line() +
    scale_y_discrete()+
    theme(axis.text.y=element_blank()) + 
    labs(x = 'Visit Age (months)', y = 'Individual', title='Visits with et data') 

et %>%
  filter(!is.na(et_collected)) %>%
  filter(cohort2!='BCP_A' & cohort2!='BCP_B' & cohort2!='BCP_C') %>%
    ggplot(data = ., aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
    geom_point(aes(color=cohort2), size=1.1) +
    geom_line() +
    scale_y_discrete()+
    theme(axis.text.y=element_blank()) + 
    labs(x = 'Visit Age (months)', y = 'Individual', title='Visits with et data') 
```


## ET & RS
```{r}
loris_vis2 %>% 
  filter(!is.na(rs_collected) & !is.na(et_collected)) %>%
    ggplot(data = ., aes(y = reorder(CandID, ageFirstVis), x = Visit_label_age)) +
    geom_point(aes(color=cohort2), size=1.1) +
    geom_line() +
    scale_y_discrete()+
    theme(axis.text.y=element_blank()) + 
    labs(x = 'Visit Age (months)', y = 'Individual', title='Visits with .pconn & ET data') 
```

```{r}
et_mri_tally = loris_vis2 %>% 
  filter(!is.na(rs_collected) & !is.na(et_collected)) %>%
  group_by(CandID) %>%
  summarize(n=n())
```
- `r sum(et_mri_tally$n)` visits from `r nrow(et_mri_tally)` individuals

```{r}
knit_exit()
```



# Old shit 

```{r} 
session_tab = vis_list %>%
  group_by(PSCID) %>%
  summarise(n_sess = length(session))
session_tab_noDSA = vis_list %>%
  filter(Cohort2!='Other') %>%
  group_by(PSCID) %>%
  summarise(n_sess = length(session))
```
<b>The final list of potential eye-tracking sessions includes:</b>  
- `r nrow(session_tab)` participants.  
- `r sum(session_tab$n_sess)` visits.  

<b>Session counts</b>  
```{r}
count(session_tab, n_sess)
```


<b>If we exclude DevSocAtt:</b>  
- `r nrow(session_tab_noDSA)` participants.  
- `r sum(session_tab_noDSA$n_sess)` visits.  

```{r}
count(session_tab_noDSA, n_sess)
```



<b>Eye-tracking visits</b>:  
```{r}
# Merge session count with vis_list
vis_list = left_join(vis_list, session_tab, by = 'PSCID')
datatable(vis_list,
          filter = 'top', options(digits = '2'))

```


How many visits do DevSocAtt kids have? 
```{r}
DSA_ids = vis_list %>% filter(Cohort2 == 'Other') %>% dplyr::select(PSCID) %>% unique()
vis_list %>%
  filter(PSCID %in% DSA_ids$PSCID) %>%
  dplyr::select(PSCID, Cohort) %>%
  group_by(PSCID) %>%
  summarise(n_visits = n()) %>%
  ungroup() %>%
  count(n_visits)
```

## visits with missing cohort info 
```{r}
vis_list %>% filter(is.na(Cohort2)) %>% dplyr::select(session, Cohort, Cohort2) %>% arrange(session)

```


```{r}
# Add age at first visit to help w/ plotting
vis_list2 = vis_list %>%
  group_by(PSCID) %>%
  # Add number of visits (n), and ageFirstVis
  summarise(ageFirstVis = min(age)) %>%
  left_join(., vis_list, by='PSCID') %>%
  ungroup() %>%
  mutate(old = ifelse(old==1, 'Old', 'New'))

```

## Visualize visits

### BSLERP
```{r bslerp_longitfig}
vis_list2 %>% filter(Cohort2=='BSLERP') %>%
  ggplot(data = ., aes(y = reorder(PSCID, ageFirstVis), x = age)) +
  geom_point(aes(color = old), size=1) +
  geom_line() +
  theme(axis.text.y=element_blank()) + 
  scale_y_discrete()+
  labs(x = 'Dancing Ladies Age (months)', y = 'Individual', title='BSLERP') 

```


```{r}
# Make df where each PSCID is a row, and New=Oldest age at newly processed vis, Old=Oldest age at visit already processed 
age_flag = vis_list2 %>%
  dplyr::select(PSCID, age, old) %>% 
  group_by(PSCID, old) %>%
  summarise(oldestVis = max(age)) %>%
  spread(key=old, value=oldestVis) %>%
  # If they only were processed in the first OR second batch, don't need to check
  filter(!is.na(New) & !is.na(Old)) %>%
  # If the oldest age at old=='Old' > oldest age at old=='New', flag 
  mutate(flag = ifelse(Old > New,1,0))

datatable(age_flag %>% 
            filter(flag ==1) %>% 
            dplyr::select(-c(flag)) , 
          colnames = c('PSCID', 'Max age in new batch', 'Max age in old batch'),
          caption = 'Cases where we missed a visit in manuscript')
```



```{r}
ids_to_check = age_flag %>% filter(flag ==1) %>% dplyr::select(PSCID) 

vis_list2 %>% 
  filter(Cohort2=='BSLERP',
         PSCID %in% ids_to_check$PSCID) %>%
  ggplot(data = ., aes(y = reorder(PSCID, ageFirstVis), x = age)) +
  geom_point(aes(color = old), size=1) +
  geom_line() +
  theme() + 
  scale_y_discrete()+
  labs(x = 'Dancing Ladies Age (months)', y = 'Individual', title='BSLERP') 

```





### BCP
```{r bcp_ab_longitfig}
vis_list2 %>% filter(grepl('BCP_A|BCP_B', Cohort2)) %>%
  ggplot(data = ., aes(y = reorder(PSCID, ageFirstVis), x = age)) +
  geom_point(aes(shape = old)) +
  geom_line(aes(color = Cohort2)) +
  theme(axis.text.y=element_blank()) + 
  scale_y_discrete()+
  labs(x = 'Dancing Ladies Age (months)', y = 'Individual', title='BCP-A, BCP-B') 
```



```{r bcp_cd_longitfig}
vis_list2 %>% filter(grepl('BCP_C|BCP_D|BCP_E', Cohort2)) %>%
  ggplot(data = ., aes(y = reorder(PSCID, ageFirstVis), x = age)) +
  geom_point(aes(shape = old)) +
  geom_line(aes(color = Cohort2)) +
  theme(axis.text.y=element_blank()) + 
  scale_y_discrete()+
  labs(x = 'Dancing Ladies Age (months)', y = 'Individual', title='BCP-C, D, E') 
```


We didn't miss any earlier BCP visits in the manuscript
```{r}
vis_list2 %>% 
  filter(grepl('BCP', Cohort2),
         PSCID %in% ids_to_check$PSCID) 
```

### DevSocAtt
```{r other_longitfig}
vis_list2 %>% filter(grepl('Other', Cohort2) | is.na(Cohort2)) %>%
  ggplot(data = ., aes(y = reorder(PSCID, ageFirstVis), x = age, color = old)) +
  geom_point() +
  geom_line() +
  theme(axis.text.y=element_blank()) + 
  scale_y_discrete()+
  labs(x = 'Dancing Ladies Age (months)', y = 'Individual', title='Other') 
```


## tallies for old vs new. 

<b>What happened w/ visits that should have been processing in the first batch?</b>  
Seems that they did not appear in the exported .nas file.  
```{r echo = TRUE}
head(ids_to_check)
vis_list2 %>% 
  filter(PSCID == ids_to_check$PSCID[1]) %>%
  dplyr::select(PSCID, session, age, old) 
```


When I search for their ID in directory w/ the raw .tsvs, '_04' is not there:
```{r}
list.files('/Users/sifre002/Box/sifre002/9_ExcelSpreadsheets/Dancing_Ladies/RawData_DancingLadies_1', pattern='JE000094', no.. = TRUE)
```


How many new kids
```{r}
new_vis = vis_list2 %>% filter(old == 'New') 
old_vis = vis_list2 %>% filter(old == 'Old')

# List of IDs that were not in the manuscript
new_partic = setdiff(new_vis$PSCID, old_vis$PSCID)
length(unique(new_partic))
```

Cohorts the new kids are from 
```{r}
# Which cohorts are they from?
vis_list2 %>%
  filter(PSCID %in% new_partic) %>%
  count(Cohort2)
```

How many new visits
```{r}
nrow(new_vis)
```

Of participants with new visits who were in the old MS, which cohorts are they in?
```{r}
new_vis %>%
  filter(PSCID %in% old_vis$PSCID) %>%
  count(Cohort2)
```

```{r}
# Merge CandID 
vis_list2=left_join(vis_list2, cohort %>% dplyr::select(PSCID, CandID) %>% distinct(), by = 'PSCID')

```








List of visits to prioritize for segmentation
```{r echo = TRUE}
knit_exit()

min_dat = read_csv(min_data_check_file)
min_dat = min_dat %>%
  # Only consider for priority if they have at least 2 time series 
  filter(`2_timeseries`=='Yes') %>%
  dplyr::select(ID, session, age, n_vis)

# Priority list
priority = vis_list2 %>%
  filter(age<=12,
         has_scan=='exists',
         session %in% min_dat$session) %>%
  dplyr::select(PSCID, session, CandID, Cohort, age,scan_name) %>%
  # Merge info on # of visits for each kid
  left_join(min_dat %>% dplyr::select(PSCID =ID, n_vis) %>% distinct(), by = c('PSCID')) %>%
  arrange(desc(n_vis))

```

  
  
```{r}
#b>Scans to prioritize for segmentation, in order of most to least visits</b>

#datatable(priority)
```


```{r}
write.csv(x = vis_list2, file = paste(out_dir, sep =''))
#write.csv(x = priority, file =  paste(wdir, 'data/segmentation_priority.csv', sep =''))
```

