---
title: "Clean data frame"
author: "Robin"
date: "02/06/2019"
output: html_document
---

```{r}
# User parameters
min_age = 0
max_age = 40
wdir = '/Users/sifre002/Documents/Code/fractal-eye-analyses/'
cleaned_precision_dat = 1 # Are you using precision data that have already been cleaned?
```

# Where do you want to save data?
```{r}
out_dir = paste(wdir, 'data/', sep = '')
file_name = '20200803_cleaned_multilevel_data'
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
library(tidyverse)
library(ggplot2)
```

# Read data
```{r}
# List of id_sessions & their ages to include to analyses (DOB is identifying info) 
particList = read_csv(file = paste(wdir, 'data/participantList.csv', sep = ''))

# Concatenated output Output from pipeline in fractal-eye-analyses-MFDFA/
h <- read_csv(file = paste(wdir, 'data/h_out.txt', sep = ''))

# Calibration precision spreadsheet  
AvgPrecision <- read.csv( paste(wdir, 'data/et_precision.csv', sep=''), stringsAsFactors = FALSE )

# Face-looking data 
aoi_data<- read.csv( paste(wdir, 'data/face_out.txt', sep ='') )

# DOB (not queriable from database)
# dob = read_csv('/Users/sifre002/Box/sifre002/9_ExcelSpreadsheets/09_MRI_metdata/20200408_BCP_DOB.csv')
```


# Format DFA output
```{r}
# Format DFA output 
h = h %>%
  # Create variable for Participant ID (currently combined with session #)
  mutate(Participant = paste(lapply(strsplit(id, '_'), '[', 1), lapply(strsplit(id, '_'), '[', 2), sep='_')) %>%
  left_join(particList, by='id') %>%
    # Create Dummies for CalVer & Pixelated
  mutate(CalVer=ifelse(grepl('Center|Left|Right', movie), 1, 0),
         Pix=ifelse(grepl('S', movie), 1, 0)) %>%
 # Variable to keep track of if theyre in participant list
  mutate(particList = ifelse(id %in% particList$id, 1, 0))

# Log who was removed 
removed_h = h %>%
  dplyr::select(Participant, id) %>%
  mutate(partic_list = ifelse(id %in% particList$id, 0, 1)) %>%
  filter(particList == 1)

# Filter if they are not in the participant list 
h = h%>% filter(particList == 0) 
```


```{r}
#Creates precisionInfo dataframe of average calibration XY precision information for each kid who made it through CalVer processing.
#Those with precision that is worse than threshold are coded as 999
# SKIP THIS PART IF YOU USING CALVER DATA THAT ALREADY HAVE BEEN CLEANED
if (cleaned_precision_dat==0) {
  source(paste(wdir, 'processing/clean_calver.R', sep = ''))
  calver=clean_calver(precisionInfo)
  calver_thresh=calver[[1]]
  AvgPrecision=calver[[2]]
}
# Merge Precision data with H data 
h2= h %>% left_join(AvgPrecision, by='id') 
```


# Flow on exclusion
## Outside of age-range
```{r}
h2 = h2 %>% mutate(remove_age = ifelse(age>=min_age & age<=max_age, 0,1))
# How many ppl were outside age-range?
h2 %>%
  filter(remove_age == 1) %>%
  summarize(n_partic = length(unique(Participant)),
            n_sess = length(unique(id)),
            n_seg = n())
```

This left us with:  
```{r}
h2 = h2 %>% filter(remove_age==0)
```
<b> `r h2 %>%dplyr::select(Participant) %>% unique() %>% nrow()` participants, `r h2  %>%dplyr::select(id) %>% unique() %>% nrow()` sessions, and `r h2  %>% nrow()` segments.  </b>

## Precision  

We removed the following data for  <b>poor calver precision</b>:  
```{r}
h2 = h2 %>% mutate( remove_precision = ifelse(is.na(Precision_RMS_X_Y),1,0) )

# Remove for precision
removed_calver = h2 %>%
  filter(remove_precision ==1)%>%
  summarize(n_partic = length(unique(Participant)),
            n_sess = length(unique(id)),
            n_seg =n())

removed_calver
```

This left us with:  
```{r}
h2 = h2 %>% filter(remove_precision==0)

```
<b> `r h2 %>%dplyr::select(Participant) %>% unique() %>% nrow()` participants, `r h2  %>%dplyr::select(id) %>% unique() %>% nrow()` sessions, and `r h2  %>% nrow()` segments.  </b>

## Interpolation  
We removed the following data for  <b>% interp</b>:  
```{r}

h2 = h2 %>% mutate(remove_propInterp = ifelse(propInterp>=quantile(propInterp,.8),1,0))

h2 %>%
  filter(remove_propInterp ==1) %>%
  summarize(n_partic = length(unique(Participant)),
            n_sess = length(unique(id)),
            n_seg =n())
```
This left us with:  
```{r}
h2 = h2 %>% filter(remove_propInterp==0)

```
<b> `r h2 %>%dplyr::select(Participant) %>% unique() %>% nrow()` participants, `r h2  %>%dplyr::select(id) %>% unique() %>% nrow()` sessions, and `r h2  %>% nrow()` segments.  </b>

## Too short  
We removed the following data for  <b>time series that were too short</b>:  
```{r}
h2 = h2 %>% mutate(remove_tooshort = ifelse(h==-9999,1,0))
write.csv(file = '/Users/sifre002/Documents/Code/fractal-eye-analyses/data/cleaned_data_incl_too_short.csv', x = h2)
# Removed for too short
h2 %>%
  filter(remove_tooshort == 1) %>%
  summarize(n_partic = length(unique(Participant)),
            n_sess = length(unique(id)),
            n_seg = n())
```

This left us with: 
```{r}
h2 = h2 %>% filter(remove_tooshort==0)
```
<b> `r h2 %>%dplyr::select(Participant) %>% unique() %>% nrow()` participants, `r h2  %>%dplyr::select(id) %>% unique() %>% nrow()` sessions, and `r h2  %>% nrow()` segments. </b>





# Clean AOI data
```{r}
aoi_data2 = aoi_data %>%
  filter(longestFixDur!=-9999) %>%
  dplyr::select(id,
          movie,
          seg,
          longestFix_aoi = longestFixDur,
          faceCount, otherCount) %>%
  mutate(id=as.character(id),
         movie=as.character(movie))
```

# Merge AOI data with H data 
```{r}
h2 = h2 %>%
  left_join(aoi_data2, by = c('id', 'movie', 'seg')) %>%
  mutate(propFace_seg = faceCount / (faceCount + otherCount))
```


# Create person-, visit-, and movie-centered variables. These are used to parse variance for modelling.
## Grand means  
```{r}
# Get grand mean for average age
AveAge = h2 %>%
  # Pull age for each person's visit (average age calculated so that their age at each visit is weighted online once)
  group_by(id)%>%
  summarise(Age = unique(age)) %>%
  # Calculate sample's average Age 
  summarise(Age = mean(Age) )

# Get grand mean for average longest fix
aveLongFix=mean(h2$longestFixDur)
avePrec=mean(h2$Precision_RMS_X_Y)
avePropFace = mean(h2$propFace_seg, na.rm = TRUE)

# Create varaible for person's age centered at grand mean 
h2=h2%>%
 mutate(Age_centeredGrandmean=as.numeric(age-AveAge$Age)) 
```
* Average age = `r AveAge`  
* Average longest fix duration = `r aveLongFix`  
* Average calver precision = `r avePrec`  
* Average % face-looking = `r avePropFace`  

## Person-level variables 
```{r}
# Creating level 3 (person) variables:
# Average age: Participant's average age (weight each visit once)
# Average Interpolated: mean prop interp
# Average precision: mean precision (weight each visit once)
# Average longest fix: mean longest fix, centered on grand mean
personLevel_var=h2%>%
  group_by(Participant)%>%
  summarise(AveAge_person=mean(Age_centeredGrandmean),
            AveInterp_person=mean(propInterp),
            AveMissing_person=mean(propMissing),
            AvePrecision_person = mean(Precision_RMS_X_Y),
            AveLongestFix_person=mean(longestFixDur),
            AvePropFace_person = sum(faceCount, na.rm = TRUE) / ( sum(faceCount, na.rm = TRUE) + sum(otherCount, na.rm = TRUE) ),
            n_person=n())
```

# Session-level variables 
```{r}
# Session age = Age_centeredGrandmean (no within-session variability)
# Average interpolated: Mean prop interp, for the session
# Average Missing: Mean prop Missing
# Average longest fix: mean longest fix, centered on grand mean
# Average face looking: mean face looking for the session
sessionLevel_var = h2 %>%
  group_by(id) %>%
  summarise(AveInterp_session = mean(propInterp),
            AveMissing_session = mean(propMissing),
            AveLongestFix_session = mean(longestFixDur),
            AvePropFace_session = sum(faceCount, na.rm = TRUE) / 
              ( sum(faceCount, na.rm = TRUE) + sum(otherCount, na.rm = TRUE) ))

```


# Movie-level
```{r}
movieLevel_var = h2 %>%
  group_by(Participant, id, movie) %>%
  summarise(AveInterp_movie = mean(propInterp),
            AveMissing_movie = mean(propMissing),
            AveLongestFix_movie = mean(longestFixDur),
            AvePropFace_movie = sum(faceCount, na.rm = TRUE) / 
              (sum(faceCount, na.rm = TRUE) + sum(otherCount, na.rm = TRUE)) )
```

```{r}
# # # # # # # # # # # #
# Create centered variables 
# # # # # # # # # # # #

# Merge person-level
h3 = merge(h2, personLevel_var, by = 'Participant')
# Merge visit-level
h4 = merge(h3, sessionLevel_var, by = 'id')
# Merge movie-level
h5 = merge(h4, movieLevel_var, by = c('Participant', 'id', 'movie'))

# Create PERSON_LEVEL variables centered at GRAND MEAN
h5$propInterp_person_grandmeancentered = h5$AveInterp_person - mean(h5$propInterp)
h5$longestFix_person_grandmeancentered  = h5$AveLongestFix_person - mean(h5$longestFixDur)
h5$propFace_person_grandmeancentered  = h5$AvePropFace_person - mean(h5$propFace_seg, na.rm = TRUE)
h5$precision_person_grandmeancentered  = h5$AvePrecision_person - mean(h5$Precision_RMS_X_Y, na.rm=TRUE)
h5$age_centered_grandmean = h5$age - AveAge$Age

# Create VISIT-LEVEL variables centered at PERSON-LEVEL
h5$propInterp_session_groupmeancentered = h5$AveInterp_session - h5$AveInterp_person
h5$longestFix_session_groupmeancentered = h5$AveLongestFix_session - h5$AveLongestFix_person
h5$propFace_session_groupmeancentered = h5$AvePropFace_session - h5$AvePropFace_person
h5$precision_session_groupmeancentered = h5$Precision_RMS_X_Y - h5$AvePrecision_person # each visit has one Precision_RMS_X_Y

# Create MOVIE-LEVEL VARIABLES centered at VISIT-LEVEL
h5$propInterp_movie_groupmeancentered = h5$AveInterp_movie - h5$AveInterp_session
h5$longestFix_movie_groupmeancentered = h5$AveLongestFix_movie - h5$AveLongestFix_session
h5$propFace_movie_groupmeancentered = h5$AvePropFace_movie - h5$AvePropFace_session

# Create SEGMENT-LEVEL VARIABLES centered at MOVIE LEVEL
h5$propInterp_segment_groupmeancentered = h5$propInterp - h5$AveInterp_movie
h5$longestFix_segment_groupmeancentered = h5$longestFixDur - h5$AveLongestFix_movie
h5$propFace_segment_groupmeancentered = h5$propFace_seg - h5$AvePropFace_movie


# Code for error checking 
# test = h5 %>% filter(id == 'JE000053_03_01' & movie == '01_converted.avi')
# test$AveAge_person
# 
# 
# test = h5 %>% filter(id == 'JE000053_03_01') %>%
#   dplyr::select(id,movie,seg,
#                 AvePropFace_person, AvePropFace_session, AvePropFace_movie,
#                 faceCount,otherCount,propFace_seg, propFace_segment_groupmeancentered, 
#                 propFace_movie_groupmeancentered, propFace_session_groupmeancentered,propFace_person_grandmeancentered)
# 
# test = h5 %>% filter(id == 'JE000053_03_01') %>%
#   dplyr::select(id, movie, seg, 
#                 AvePropFace_person, AvePropFace_session, AvePropFace_movie,
#                 faceCount,otherCount,propFace_seg, propFace_segment_groupmeancentered, 
#                 propFace_movie_groupmeancentered, propFace_session_groupmeancentered,propFace_person_grandmeancentered)
# # test visit-level face avg 
# sum(test$faceCount, na.rm = TRUE) / (sum(test$faceCount, na.rm = TRUE)  + sum(test$otherCount, na.rm = TRUE))
# # Test movie-level face 
# a = test %>% filter(movie == '01_converted.avi') 
# sum(a$faceCount, na.rm = TRUE) / (sum(a$faceCount, na.rm = TRUE)  + sum(a$otherCount, na.rm = TRUE))
# # test - segment level prop face
# test[1, 'faceCount'] / (test[1, 'faceCount'] + test[1, 'otherCount'])
# test[1, 'propFace_seg']
# # test segment - level cnetering
# test[1, 'propFace_seg'] - test[1, 'AvePropFace_movie'] == test[1, 'propFace_segment_groupmeancentered']
# test[1, 'AvePropFace_movie'] - test[1, 'AvePropFace_session'] == test[1, 'propFace_movie_groupmeancentered']
# test[1, 'AvePropFace_session'] - test[1, 'AvePropFace_person'] == test[1, 'propFace_session_groupmeancentered']
# test[1, 'AvePropFace_person'] - avePropFace == test[1, 'propFace_person_grandmeancentered']


```

```{r}
# optional: save output
write_csv(x = h5, path = paste(out_dir, 'cleaned_data.csv', sep=''))
```

