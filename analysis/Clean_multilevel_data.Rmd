---
title: "Clean data frame"
author: "Robin"
date: "02/06/2019"
output: html_document
---

```{r}
# User parameters
min_age = 0
max_age = 40
```

# Where do you want to save data?
```{r}
out_dir = '/Users/sifre002/Box/sifre002/9_ExcelSpreadsheets/Dancing_Ladies/clean_data/'
file_name = 'cleaned_multilevel_data'
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
#library(readxl)
library(tidyverse)
#library(dplyr)
#library(sm)
#library(lme4)
library(ggplot2)
#library(MuMIn)
#library(bbmle)
#library(gtools)
#library(tuple)
#library(utils)
```

# Read data
```{r}
h <- read_csv(file = "/Users/sifre002/Box/sifre002/7_MatFiles/01_Complexity/Individual_Data/h_out.txt")

#precisionInfo = read.csv('/Users/sifre002/Documents/Code/fractal-eye-analyses/out/calibration_verification.csv')
precisionInfo = read.csv('/Users/sifre002/Documents/Code/fractal-eye-analyses/out/calibration_verification.csv')

aoi_data<- read.csv("/Users/sifre002/Box/sifre002/9_ExcelSpreadsheets/Dancing_Ladies/aoi_data/2019_01_10_groupAoiData.txt", sep = '\t')

# demographic data
demo = read_csv('/Users/sifre002/Box/sifre002/9_ExcelSpreadsheets/09_MRI_metdata/demographic_info.csv')

# DOB (not queriable from database)
dob = read_csv('/Users/sifre002/Box/sifre002/9_ExcelSpreadsheets/09_MRI_metdata/20200408_BCP_DOB.csv')
```



# Format demograpic data 
```{r}
source('/Users/sifre002/Documents/Code/misc/clean_loris_demographic.R')
demo2 = clean_demographic_data(demo)
# Filter for data from BCP/BSLERP
demo2 = demo2 %>%
  filter(grepl('BCP|DSA_Demographics', cohort)) %>%
  filter(!grepl('mom|Parent|Phantom', cohort)) %>%
  mutate(cohort2=ifelse(grepl('BCP',cohort), 'BCP', 'DSA')) %>%
  mutate(male=ifelse(sex=='Male',1,0)) 
# Merge DOB with demographic data
dob = dob %>%
  select(id=PSCID, DoB)
demo2 = demo2 %>%
  left_join(dob, by = 'id')
```

# Format DFA output
```{r}
# Format DFA output 
h = h %>%
  # Create variable for Participant ID (currently combined with session #)
  mutate(Participant = paste(lapply(strsplit(id, '_'), '[', 1), lapply(strsplit(id, '_'), '[', 2), sep='_')) %>%
  left_join(dob, by=c('Participant'='id')) %>%
  # Calculate age at time of visit 
  mutate(DoB =as.Date(DoB, format='%m/%d/%y'),
         date=as.Date(date, format='%m/%d/%Y')) %>%
  mutate(age=(date-DoB)/30.42,
         age=as.numeric(age))%>%
    # Create Dummies for CalVer & Pixelated
  mutate(CalVer=ifelse(grepl('Center|Left|Right', movie), 1, 0),
         Pix=ifelse(grepl('S', movie), 1, 0)) 

# Filter 
h2 = h%>%
  # If % interpolated is more than 80th percentile threshold, then remove from sample 
  filter(propInterp<quantile(propInterp, .8)) %>%
  # If time series was too short, remove from sample
  filter(warning==0) %>%
  # filter for age range
  filter(age>min_age & age<max_age) 

# Info on which trials were removed
removed_h=h %>%
  select(id,movie,seg,propInterp,warning,age)%>%
  mutate(removed_tooshort=ifelse(warning==1,1,0),
         removed_propInterp=ifelse(propInterp>quantile(propInterp, .8),1,0),
         removed_age=ifelse(age<min_age|age>max_age,1,0)) %>%
  select(-c(propInterp,warning,age)) %>%
  filter(removed_tooshort==1|removed_propInterp==1|removed_age==1) 

# sanity
test = h2 %>% group_by(id) %>% summarise(n=n())

```


Clean AOI data
```{r}
aoi_data2 = aoi_data %>%
  filter(longestFix_Dur!=-9999) %>%
  select(id,
          movie,
          seg, 
          longestFix_aoi = longestFix_Dur, 
          faceCount, otherCount) %>%
  mutate(id=as.character(id),
         movie=as.character(movie))
```


Creates precisionInfo dataframe of average calibration XY precision information for each kid who made it through CalVer processing
```{r}

# If output, use code below
if (n_distinct(precisionInfo[,1])==nrow(precisionInfo)) { # Precision Info already summarized 
  precisionInfo2=precisionInfo %>%
  select(id=ID,
        AvgPrecision)

  cutoff=mean(precisionInfo2$AvgPrecision, na.rm=TRUE)+2*(sd(precisionInfo2$AvgPrecision,na.rm=TRUE))
  precisionInfo2=precisionInfo2%>%
    filter(AvgPrecision<cutoff) # remove trials above the acceptable cutoff (not included in final sample)
  avg_prec=precisionInfo2
} else{ 
  precisionInfo2 = precisionInfo %>%
    filter(!is.na(CoordX)) %>% # If missing info for X, always missing for Y as well
    mutate(Precision_RMS_X_Y=(PrecRMSx+PrecRMSy)/2) %>%
    select(id=X, Precision_RMS_X_Y, Stimulus,Order) %>%
    distinct()
  
    #Establish threshold for acceptable precision value based on 2 SDs above sample mean
   cutoff=mean(precisionInfo2$Precision_RMS_X_Y, na.rm=TRUE)+2*sd(precisionInfo2$Precision_RMS_X_Y, na.rm=TRUE)
   
   # Remove bad points from data
   precisionInfo3=precisionInfo2 %>%
      filter(Precision_RMS_X_Y<cutoff)
  
  #Summarize mean precision for each participant
  avg_prec=precisionInfo3%>%
    filter(Precision_RMS_X_Y<cutoff) %>%# remove trials above the acceptable cutoff (not included in final sample)
    group_by(id)%>%
    summarise(AvgPrecision=mean(Precision_RMS_X_Y)) %>%
    ungroup() %>%
    mutate(id=as.character(id))
  
  # Add back in participants with bad precision
  excludedSess=setdiff(precisionInfo2$id, precisionInfo3$id)
  temp=data.frame(id=excludedSess, AvgPrecision=999)
  avg_prec=rbind(avg_prec,temp)
}


```

# Merge demographic, DFA, aoi, and precision data
```{r}
dim(h2)  #9274
h3=h2%>%
  left_join(avg_prec, by='id') %>% #Add precision info for each visit id
  left_join(aoi_data2, by=c('id','movie','seg')) %>%#add aoi_data for each segment
  left_join(demo2, by=c('Participant'='id'))

test = h3%>%filter(is.na(AvgPrecision)) %>% select(id) %>% unique()

```




Add individual precision info FROM FINALCALVER to MFDFA & includes only those w/ precision data in FinalCalvr  
```{r message=FALSE, warning=FALSE, echo=FALSE}
colnames(FinalCalVer)[colnames(FinalCalVer)=="AvgPrecision"] <- "PrecisionRMS_X_Y"
FinalCalVer$precisionInfo = 1
Master3 = merge(Master2,FinalCalVer, by="ID", all.x=TRUE)
Master_precInf=Master3%>%
  filter(precisionInfo==1)
# Useful for reporting purposes 
#a=unique(Master_precInf$ID)
#a=unique(as.character(Master_precInf$Participant))

#Filters out those without precision info (i.e., did not make it through CalVer/did not have any points above quality thresholds from previous code)
Master3=Master3%>%
  filter(precisionInfo==1)
#a=unique(Master$ID) #131

#Center precision on grand mean (will use this for modelling)
avePrec=mean(Master3$PrecisionRMS_X_Y)
Master3=Master3%>%
  mutate(PrecisionRMS_X_Y_centered=PrecisionRMS_X_Y-avePrec)
```



Merge aoi data with master_longit
```{r}
Master_longit = Master3 %>%
  dplyr::select(ID, Participant, LongestFixDuration, PropInterp, PropMissing, PrecisionRMS_X_Y,Amplitude, H, SpectWidth, Age, MovieName, Seg, Stimulus, Version, Pixelated, NonPixelated, Calver, Stimulus,Sex, female, cohort_dummy)
temp1 = Master_longit %>% filter(Stimulus=='DL') # only movie trials
temp2 = Master_longit %>% filter(Stimulus=='C') # only CalVer trials

test =merge(temp1, aoi_data2, by = c('ID', 'MovieName', 'Seg'))
test$propFace_seg = test$faceCount / (test$faceCount + test$otherCount)

temp2$longestFix_aoi = NA
temp2$faceCount = NA
temp2$otherCount = NA
temp2$propFace_seg = NA

Master_longit2 = rbind(test, temp2)
```


# Create person-, visit-, and movie-centered variables. These are used to parse variance for modelling.
```{r}
# Get grand mean for average age
AveAge = Master_longit2 %>%
  group_by(ID)%>%
  summarise(Age = unique(Age)) %>%
  summarise(Age = mean(Age) )

# Get grand mean for average longest fix
aveLongFix=mean(Master_longit2$LongestFixDuration)
AveAge = Master_longit2 %>%
  group_by(ID) %>%
  summarise(age = mean(Age))
AveAge = mean(AveAge$age)
#avePrec=mean(Master_longit2$PrecisionRMS_X_Y)
#avePropFace = mean(Master_longit2$propFace_seg, na.rm = TRUE)

#
Master_longit2=Master_longit2%>%
  mutate(Age_centeredGrandmean=as.numeric(Age-AveAge),
         longestFix_seg_centeredGrandmean = as.numeric(LongestFixDuration - aveLongFix))

# Creating level 3 (person) variables:
# Average age: Participant's average age, centered on grand mean
# Average Interpolated: mean prop interp
# Average precision: mean precision (weight each visit once)
# Average longest fix: mean longest fix, centered on grand mean 
# Average face looking: NEED TO ADD THIS 
personLevel_var=Master_longit2%>%
  group_by(Participant)%>%
  summarise(AveAge_person=mean(unique(Age_centeredGrandmean)), 
            AveInterp_person=mean(PropInterp),
            AveMissing_person=mean(PropMissing),
            AvePrecision_person = mean(PrecisionRMS_X_Y),
            AveLongestFix_person=mean(longestFix_seg_centeredGrandmean),
            AvePropFace_person = sum(faceCount, na.rm = TRUE) / ( sum(faceCount, na.rm = TRUE) + sum(otherCount, na.rm = TRUE) ),
            n_person=n())

# Session age = Age_centeredGrandmean (no within-session variability)
# Average interpolated: Mean prop interp, for the session
# Average Missing: Mean prop Missing
# Average longest fix: mean longest fix, centered on grand mean
# Average face looking: mean face looking for the session 
sessionLevel_var = Master_longit2 %>%
  group_by(ID) %>%
  summarise(AveInterp_session = mean(PropInterp),
            AveMissing_session = mean(PropMissing), 
            AveLongestFix_session = mean(longestFix_seg_centeredGrandmean),
            AvePropFace_session = sum(faceCount, na.rm = TRUE) / ( sum(faceCount, na.rm = TRUE) + sum(otherCount, na.rm = TRUE) ))


movieLevel_var = Master_longit2 %>%
  group_by(Participant, ID, MovieName) %>%
  summarise(AveInterp_movie = mean(PropInterp),
            AveMissing_movie = mean(PropMissing), 
            AveLongestFix_movie = mean(longestFix_seg_centeredGrandmean),
            AvePropFace_movie = sum(faceCount, na.rm = TRUE) / ( sum(faceCount, na.rm = TRUE) + sum(otherCount, na.rm = TRUE) ))

# Merge person-level
Master_longit3 = merge(Master_longit2, personLevel_var, by = 'Participant')
# Merge visit-level
Master_longit4 = merge(Master_longit3, sessionLevel_var, by = 'ID')
# Merge movie-level
Master_longit5 = merge(Master_longit4, movieLevel_var, by = c('Participant', 'ID', 'MovieName'))
# Create SEGMENT-LEVEL VARIABLES centered at MOVIE LEVEL
Master_longit5$propInterp_segment_groupmeancentered = Master_longit5$PropInterp - Master_longit5$AveInterp_movie
Master_longit5$longestFix_segment_groupmeancentered = Master_longit5$longestFix_seg_centeredGrandmean - Master_longit5$AveLongestFix_movie
Master_longit5$propFace_segment_groupmeancentered = Master_longit5$propFace_seg - Master_longit5$AvePropFace_movie

# Create MOVIE-LEVEL VARIABLES centered at VISIT-LEVEL
Master_longit5$propInterp_movie_groupmeancentered = Master_longit5$AveInterp_movie - Master_longit5$AveInterp_session
Master_longit5$longestFix_movie_groupmeancentered = Master_longit5$AveLongestFix_movie - Master_longit5$AveLongestFix_session
Master_longit5$propFace_movie_groupmeancentered = Master_longit5$AvePropFace_movie - Master_longit5$AvePropFace_session

# Create VISIT-LEVEL variables centered at PERSON-LEVEL
Master_longit5$propInterp_session_groupmeancentered = Master_longit5$AveInterp_session - Master_longit5$AveInterp_person
Master_longit5$longestFix_session_groupmeancentered = Master_longit5$AveLongestFix_session - Master_longit5$AveLongestFix_person
Master_longit5$propFace_session_groupmeancentered = Master_longit5$AvePropFace_session - Master_longit5$AvePropFace_person
Master_longit5$precision_session_groupmeancentered = Master_longit5$PrecisionRMS_X_Y - Master_longit5$AvePrecision_person

# Create PERSON_LEVEL variables centered at GRAND MEAN
Master_longit5$propInterp_person_grandmeancentered = Master_longit5$AveInterp_person - mean(Master_longit5$PropInterp)
Master_longit5$longestFix_person_grandmeancentered  = Master_longit5$AveLongestFix_person - mean(Master_longit5$AveLongestFix_person)
Master_longit5$propFace_person_grandmeancentered  = Master_longit5$AvePropFace_person - mean(Master_longit5$propFace_seg, na.rm = TRUE)
Master_longit5$precision_person_grandmeancentered  = Master_longit5$AvePrecision_person - mean(Master_longit5$PrecisionRMS_X_Y, na.rm=TRUE)

############################################################################
#Commented out code - could be useful or reporting 

#Finds participant info
# Master_longit_sample=Master_longit4%>%
#   group_by(Participant, ID)%>%
#   summarise(n=n(),
#             female=mean(as.numeric(female, na.rm=TRUE)))
# Master_longit_female=Master_longit4%>%
#   filter(female==1)%>%
#   group_by(Participant)%>%
#   summarise(n=n())

# N_female=unique(Master_longit_female$Participant)
# mean(Master_longit$PropMissing, na.rm=TRUE)

# #Finds time pts per kid
# library(tuple)
# Master_longit_sum=Master_longit%>%
#   group_by(Participant, ID)%>%
#   summarize(n())%>%
#   mutate(dummy=1)%>%
#          # dup=duplicated(Participant),
#          # trip=triplicated(Participant))%>%
#   group_by(Participant)%>%
#   summarize(sessions=sum(dummy))

```

<!-- Sanity checking  -->
<!-- ```{r} -->
<!-- model_data = Master_longit5 %>% filter(Stimulus == 'DL') -->

<!-- ggplot(data = model_data, aes(x = Age, y = H) ) + -->
<!--   stat_smooth(method = 'lm', se = FALSE,  formula = y~x, show.legend = FALSE, aes(group = MovieName, color = MovieName)) + -->
<!--   stat_smooth(method ='lm', formula = y~x, color = 'black') -->

<!-- library(psychometric) -->
<!-- ICC1.lme(H, MovieName, model_data)   -->

<!-- ``` -->

Save data 
```{r}
write.csv(file = paste(out_dir, file_name, '.csv', sep= ''), Master_longit5)
```



