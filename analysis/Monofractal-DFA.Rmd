---
title: "Monofractal DFA"
author: "Robin Sifre"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: kate
    self_contained: true
---


```{r message=FALSE, warning = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(readr)
library(tidyverse)

library(ggplot2)
library(ggeffects)

# modeling 
library(AICcmodavg)
library(bbmle)
library(merTools)
library(nlme)
library(lme4)
library(sjPlot)
library(lmerTest)
library(interactions)
library(cowplot)

library(moments) 
library(sm)
library(knitr)
library(DT)
library(lubridate)

lmeControl(maxIter = 200, msMaxIter = 200, niterEM = 50, msMaxEval = 100)
ctrl <- lmeControl(opt='optim')

```

# About
To-do:  
- Add code for simple slopes 
o	Figures of relationship between age and QC metrics 

```{r echo=TRUE}
wdir = '~/Documents/Github/fractal-eye-analyses/'
source('~/Documents/GitHub/fractal-eye-analyses/analysis/Rfuncs/compareNA.R')

# Read cleaned data
clean_dat = read.csv( paste(wdir, 'data/2021-03-31-h_clean.csv', sep = ''), stringsAsFactors = FALSE )

# Read cases that were removed
removed = read.csv( paste(wdir, 'data/2021-03-31-h_removed.csv', sep = ''), stringsAsFactors = FALSE )

```

```{r clean_surr, cache=TRUE}
visits = unique(clean_dat$id)
```

```{r calc_surr_avg_H, cache=TRUE}
# Make average H for each time series
# surr = surr %>%
#   dplyr::select(id, movie, seg, date, longestFixDur, propInterp, propMissing, surrogate_num, H) %>%
#   # Make unique label for each time series (that does not include surrogate number)
#   mutate(temp=paste(id,movie,seg,date,longestFixDur,propInterp,propMissing)) %>%
#   pivot_wider(id_cols=temp, names_from=surrogate_num, names_prefix = 'surr', 
#               values_from=H) %>%
# rowwise() %>%
# mutate(mean_h = mean(c(surr1, surr2, surr3, surr4, surr5, surr6, surr7, surr8)))
  

```

```{r}
clean_dat = clean_dat %>%
  mutate(temp=paste(id,movie,seg,date,longestFixDur,propInterp,propMissing))
```



```{r}
# Make variables needed for models 
clean_dat = clean_dat %>% 
  mutate(female = ifelse(Sex=='Female', 1,0),
         Trial = ifelse(CalVer==0 & Pix==0, 'Social', ''),
         Trial = ifelse(CalVer==1, 'Attention-Getter', Trial),
         Trial = ifelse(Pix==1, 'Pixelated', Trial),
         social = ifelse(Trial=='Social', 1, 0))  %>%
  group_by(id) %>%
  mutate(n_social = sum(Trial=='Social'),
         n_pix = sum(Trial=='Pixelated'),
         prop_social = n_social/(n_social + n_pix),
         # Divide these by 1000 to get them on similar scale to other preidictors 
         longestFix_segment_groupmeancentered_s = longestFix_segment_groupmeancentered/1000,
         longestFix_session_groupmeancentered_s = longestFix_session_groupmeancentered/1000,
         longestFix_person_grandmeancentered_s = longestFix_person_grandmeancentered/1000) %>%
  ungroup()

# Get grand mean for average age
AveAge = clean_dat %>%
  dplyr::select(id, et_age) %>%
  distinct() %>%
  pull(et_age) %>%
  mean()
```



# DFA 


Testing for normality 
```{r message=FALSE, warning=FALSE}
# The values for asymmetry and kurtosis between -2 and +2 are considered acceptable in order to prove normal univariate distribution (George & Mallery, 2010)
sm.density(clean_dat$h, xlab="H (Hurst Exponent) of Looking Patterns", model="normal")

qqnorm(clean_dat$h);qqline(clean_dat$h, col = 2)
```

```{r echo=TRUE}
skew=skewness(clean_dat$h) #btw -2 and 2 ideally
kurtosis=kurtosis(clean_dat$h) #3 for a normal distribution
skew
kurtosis
```

Range of H
```{r}
summary(clean_dat$h) 
```


Proportion of time series that are considered "pink noise"
```{r echo=TRUE}
clean_dat$pink=NA
clean_dat$pink=ifelse(clean_dat$h>0.69 & clean_dat$h<1.1, 1, 0)
sum(clean_dat$pink==1)/nrow(clean_dat)
```

# Visualize IVs
```{r iv_hists, warning=FALSE}
ggplot(data=clean_dat, aes(x=et_age)) +
  geom_histogram(color='black')
ggplot(data=clean_dat, aes(x=age_centered_grandmean)) +
  geom_histogram(color='black')
```

```{r}

```


# Visualize outcomes
```{r face_hists, warning=FALSE}
ggplot(data=clean_dat, aes(x=propFace_seg)) +
  geom_histogram(color='black')

```



```{r echo=TRUE}
#summary(surr$mean_h)
```

```{r h_vs_surrH}
# ggplot(data=surr, aes(x=mean_h))+
#   geom_histogram(color='black')
```

```{r}
# ggplot(data=clean_dat, aes(x=h, y=mean_h)) +
#   geom_point(alpha=0.2) + 
#   labs(x='H of original data', y = 'Average surrogate H') +
#   geom_abline(slope=1, color='red')
```


# Modeling H Trajectories

```{r message=FALSE, warning=FALSE, echo=FALSE, include=FALSE}
lmeControl(maxIter = 400, msMaxIter = 400, niterEM = 100, msMaxEval = 1000)
ctrl <- lmeControl(opt='optim')
```

## Determine which levels to model intercept for 
### Baseline mod
```{r}
lmer.0=lmer(h~1+(1|PSCID)+(1|id)+(1|movie), data=clean_dat, REML=FALSE) #int-only w/ nested structures
summary(lmer.0)
```


```{r echo=FALSE, include=FALSE}
remat <- print(VarCorr(lmer.0),comp=c("Variance", "Std.Dev."))
```

```{r}
remat<- data.frame(remat)
PSCID_var = remat %>% filter(grp=='PSCID') %>% pull(vcov)
sess_var = remat %>% filter(grp=='id') %>% pull(vcov)
mov_var = remat %>% filter(grp=='movie') %>% pull(vcov)
resid_var= remat %>% filter(grp=='Residual') %>% pull(vcov)
total_var = PSCID_var + sess_var+ mov_var + resid_var
```

```{r echo=TRUE}
PSCID_var/total_var
sess_var/total_var
mov_var/total_var
resid_var/total_var
```

Since movie accounts for < 3% of total variance, model RE for intercept for person, visit only. 


## Determine functional form 
Fixed effect of $Age$
```{r fixef_age, cache=TRUE, echo=TRUE}
# Intercept only  
lmer.0=lmer(h ~ 1 + (1|PSCID)+(1|id), data=clean_dat, 
            REML=FALSE) 
# Linaer FE 
lmer.1=lmer(h ~ 1+ Age_centeredGrandmean + (1|PSCID)+(1|id), data=clean_dat,                
            REML=FALSE) 
# Quadratic FE 
lmer.2=lmer(h ~ 1+ Age_centeredGrandmean + I(Age_centeredGrandmean^2) + 
              (1|PSCID)+(1|id), 
            data=clean_dat,               
            REML=FALSE) #quadratic age
anova(lmer.0, lmer.1, lmer.2)
```

RE of $Age$
Quadratic RE of age leads to convergence issue 
```{r echo=TRUE}
lmer.2b=lmer(h~1+ Age_centeredGrandmean + I(Age_centeredGrandmean^2)+
               (1+Age_centeredGrandmean|PSCID)+(1|id),
             data=clean_dat, REML=FALSE) #quadratic age

```


```{r}
# mynames <- as.character (c("lmer.2", "lmer.2b"))
# myaicc  <- ICtab(logLik(lmer.2),
# 		     logLik(lmer.2b),
# 		     type ="AICc",
# 		     nobs = nrow(na.omit(clean_dat)),
# 		     weights =TRUE,delta =TRUE,sort=TRUE,mnames=mynames,base=TRUE)
# 
# myaicc$rweight <- max(myaicc$weight)/myaicc$weight
# myaicc
```

How much variance does model with age explain alone?

```{r var_explained_age, echo=TRUE, cache=TRUE, warning=FALSE}
# Description of func:
# By drawing a sampling distribution for the random and the fixed effects and then estimating the fitted value across that distribution, it is possible to generate a prediction interval for fitted values that includes all variation in the model except for variation in the covariance parameters, theta
pred_out<-predictInterval(merMod = lmer.2, newdata = clean_dat,
                          level = 0.95, n.sims = 1000,
                          stat = "median",
                          type="linear.prediction",
                          include.resid.var = TRUE)
clean_dat$yhat1=pred_out$fit

#clean_dat$yhat2 = predict(lmer.2, newdata=clean_dat)
R = cor(clean_dat$h, clean_dat$yhat1, use = "complete.obs")
R^2 
```

```{r age_plot}
pred = ggpredict(lmer.2, 
          # terms: names of those terms from model, for which marginal effects should be displayed.
          # [all] includes quadratic too
          terms = 'Age_centeredGrandmean [all]', 
          type='random')
#https://cran.r-project.org/web/packages/ggeffects/vignettes/ggeffects.html
ggplot(data=clean_dat, aes(x=Age_centeredGrandmean+AveAge, y = h)) +
  geom_jitter(alpha=.2) +
  geom_line(data=pred, aes(x=x+AveAge, y = predicted), color='red') +
  labs(title='Raw data with marginal effect of age plotted',
       x='Age (months)', y = expression(Raw~alpha)) +
  theme_bw()


ggplot(data=pred, aes(x=x, y = predicted)) +
  geom_line(aes(y=predicted)) + 
  geom_ribbon(aes(ymin=conf.low, ymax=conf.high), fill='red',alpha=.2 ) +
  labs(title='Marginal effect of age with 95% CI', x='Age (months)', 
       y=expression(Predicted~alpha))

```



## Modeling covariates:  
```{r echo=TRUE, cache=TRUE}
# Adding in covariates
lmer.3a = lmer(h ~ 1 + Age_centeredGrandmean + I(Age_centeredGrandmean^2) +
                # segment-level
                propInterp_segment_groupmeancentered + longestFix_segment_groupmeancentered_s + 
                # session-level
                propInterp_session_groupmeancentered +longestFix_session_groupmeancentered_s +
                precision_session_groupmeancentered + 
                # Person-level
                propInterp_person_grandmeancentered +
                longestFix_person_grandmeancentered_s + 
                precision_person_grandmeancentered + factor(cohort_bin) + factor(female)+
                (1 |PSCID) + (1|id), 
               data=clean_dat, REML=FALSE) #linear age

summary(lmer.3a)

#FINAL COVARIATE MODEL
lmer.3b=lmer(h ~ 1 + Age_centeredGrandmean + I(Age_centeredGrandmean^2) +
                # session-level
                propInterp_session_groupmeancentered + 
               longestFix_session_groupmeancentered + 
                precision_session_groupmeancentered + 
                # Person-level
                longestFix_person_grandmeancentered + 
                precision_person_grandmeancentered +
                (1|PSCID) + (1|id),
                data=clean_dat, REML=FALSE)
```

Verify that removign n.s. control covariates does not worsen model fit 
```{r}
anova(lmer.3a, lmer.3b)
```


## Modeling effect of Stimulus type 

```{r pix_maineff, cache=TRUE, echo=TRUE}
lmer.4=lmer(h ~ 1 + Age_centeredGrandmean + I(Age_centeredGrandmean^2) +
                # session-level
                propInterp_session_groupmeancentered + 
               longestFix_session_groupmeancentered + 
                precision_session_groupmeancentered + 
                # Person-level
                longestFix_person_grandmeancentered + 
                precision_person_grandmeancentered +
                Pix + CalVer +
                (1|PSCID) + (1|id),
                data=clean_dat, REML=FALSE)
```

Model results 
```{r}
summary(lmer.4)
```

Does adding `Pix` and `CalVer` improve MLE?
```{r}
anova(lmer.3b, lmer.4)
```


```{r lrt, cache=TRUE, include=TRUE, echo=TRUE}
#LRTs to justify pix and calver separately 
lmer.4a=lmer(h ~ 1 + Age_centeredGrandmean + I(Age_centeredGrandmean^2) +
                # session-level
                propInterp_session_groupmeancentered + 
                longestFix_session_groupmeancentered + 
                precision_session_groupmeancentered + 
                # Person-level
                longestFix_person_grandmeancentered + 
                precision_person_grandmeancentered +
                Pix + 
                (1|PSCID) + (1|id),
                data=clean_dat, REML=FALSE)
anova(lmer.3b, lmer.4a)

lmer.4b=lmer(h ~ 1 + Age_centeredGrandmean + I(Age_centeredGrandmean^2) +
                # session-level
                propInterp_session_groupmeancentered + 
                longestFix_session_groupmeancentered + 
                precision_session_groupmeancentered + 
                # Person-level
                longestFix_person_grandmeancentered + 
                precision_person_grandmeancentered +
                CalVer + 
                (1|PSCID) + (1|id),
                data=clean_dat, REML=FALSE)
anova(lmer.3b, lmer.4b)
```


## Calver x age 
```{r calverbyage, cache=TRUE, echo=TRUE}
lmer.5 = lmer(h ~ 1 + Age_centeredGrandmean + I(Age_centeredGrandmean^2) +
       # session-level
       propInterp_session_groupmeancentered + 
       longestFix_session_groupmeancentered + 
       precision_session_groupmeancentered + 
       # Person-level
       longestFix_person_grandmeancentered + 
       precision_person_grandmeancentered +
       # Condition
       Pix + CalVer + 
       CalVer:Age_centeredGrandmean + CalVer:I(Age_centeredGrandmean^2) + 
       (1|PSCID) + (1|id),
      data=clean_dat, REML=FALSE)
```

Model output
```{r calverbyage_out}
summary(lmer.5)
```


## Pix x Age 
```{r pixbyage, cache=TRUE}
lmer.6 = lmer(h ~ 1 + Age_centeredGrandmean + I(Age_centeredGrandmean^2) +
       # session-level
       propInterp_session_groupmeancentered + 
       longestFix_session_groupmeancentered + 
       precision_session_groupmeancentered + 
       # Person-level
       longestFix_person_grandmeancentered + 
       precision_person_grandmeancentered +
       # Condition
       Pix + CalVer + 
       CalVer:Age_centeredGrandmean + CalVer:I(Age_centeredGrandmean^2) + 
      Pix:Age_centeredGrandmean + Pix:I(Age_centeredGrandmean^2) + 
       (1|PSCID) + (1|id),
      data=clean_dat, REML=FALSE)


```

```{r}
summary(lmer.6)
```

<b>Select Best-fitting model between:</b>  
- main effects  
- main effects + Age x Calver  
- main effects + Age x Calver + Age x Pix
```{r}
anova(lmer.4, lmer.5, lmer.6)
```


# Final model

## Marginal effect of age 
```{r plot_finalmod_age, cache=TRUE}
pred = ggpredict(lmer.6, 
          # terms: names of those terms from model, for which marginal effects should be displayed.
          # [all] includes quadratic too
          terms = 'Age_centeredGrandmean [all]', 
          type='random')

#https://cran.r-project.org/web/packages/ggeffects/vignettes/ggeffects.html
ggplot(data=clean_dat, aes(x=Age_centeredGrandmean+AveAge, y = h)) +
  geom_jitter(alpha=.2) +
  geom_line(data=pred, aes(x=x+AveAge, y = predicted), color='red') +
  labs(title='Raw data with marginal effect of age plotted',
       x='Age (months)', y = expression(Raw~alpha)) +
  theme_bw()

ggplot(data=pred, aes(x=x, y = predicted)) +
  geom_line(aes(y=predicted)) + 
  geom_ribbon(aes(ymin=conf.low, ymax=conf.high), fill='red',alpha=.2 ) +
  labs(title='Marginal effect of age with 95% CI', x='Age (months)', 
       y=expression(Predicted~alpha)) + theme_bw()
```

## Marginal effect of stimulus types
```{r plot_finalage_by_stimtype}
# Get predicted marginal effects for Age xCondition effects 
pred_cal = ggpredict(lmer.6, 
          # terms: names of those terms from model, for which marginal effects should be displayed.
          # [all] includes quadratic too
          terms = c('Age_centeredGrandmean [all]','CalVer [all]'), 
          type='random')
pred_cal_df = data.frame(age = pred_cal$x, h=pred_cal$predicted, calver=pred_cal$group,
                         cu = pred_cal$conf.high, cl = pred_cal$conf.low)

pred_pix = ggpredict(lmer.6, 
          terms = c('Age_centeredGrandmean [all]', 'Pix [all]'), 
          type='random')
pred_pix_df = data.frame(age = pred_pix$x, h=pred_pix$predicted, pix=pred_pix$group,
                         cu=pred_pix$conf.high, cl=pred_pix$conf.low)

# This is the reference group 
pred_dl = ggpredict(lmer.6, 
          terms = c('Age_centeredGrandmean [all]'), 
          type='random')
pred_dl_df = data.frame(age = pred_dl$x, h=pred_dl$predicted,
                        cl = pred_dl$conf.low, cu=pred_dl$conf.high)

# Merge the predicted values together
plot_dat = rbind(pred_cal_df %>% 
                   filter(calver==1) %>%
                   dplyr::select(age, h, cu, cl, Trial=calver) %>%
                   mutate(Trial='CalVer'), 
                 pred_pix_df %>%
                   filter(pix==1) %>%
                   dplyr::select(age, h, cu, cl, Trial=pix) %>%
                   mutate(Trial='Pixelated'),
                 pred_dl_df %>%
                   mutate(Trial='Social'))

# Make factor so legend is in the right order
plot_dat$Trial = factor(plot_dat$Trial, levels=c('Social', 'Pixelated', 'CalVer'),
                        labels = c('Social', 'Pixelated', 'Attention-Getter'))

ggplot(data=clean_dat, aes(x=Age_centeredGrandmean+AveAge, y = h)) +
  geom_jitter(alpha=.2) +
  geom_line(data=plot_dat, aes(x=age+AveAge, y = h, color=Trial)) +
  labs(title='Raw data with marginal effect of trial type x Age',
       x='Age (months)', y = expression(Raw~alpha)) +
  theme_bw()

ggplot(data=clean_dat, aes(x=Age_centeredGrandmean+AveAge, y = h)) +
  geom_jitter(alpha=.2) +
  geom_line(data=plot_dat, aes(x=age+AveAge, y = h, color=Trial)) +
  labs(title='Raw data with marginal effect of Condition x Age',
       x='Age (months)', y = expression(Raw~alpha),
       caption=expression('Y-axis limits set to Average \u03b1 +/- 2 SDs')) +
  scale_y_continuous(limits = c(mean(clean_dat$h)-2*sd(clean_dat$h),
                                mean(clean_dat$h)+2*sd(clean_dat$h))) +
  theme_bw()

```

## Simples slopes
```{r}
clean_dat = clean_dat %>%
  mutate(Age_centeredGrandmean2 = Age_centeredGrandmean^2)

# Re-make model with variable for age2 for sim slopes package 
lmer.fin = lmer(h ~ 1 + Age_centeredGrandmean + Age_centeredGrandmean2 + 
       # session-level
       propInterp_session_groupmeancentered + 
       longestFix_session_groupmeancentered + 
       precision_session_groupmeancentered + 
       # Person-level
       longestFix_person_grandmeancentered + 
       precision_person_grandmeancentered +
       # Condition
       Pix + CalVer + 
       CalVer:Age_centeredGrandmean + CalVer:Age_centeredGrandmean2 + 
      Pix:Age_centeredGrandmean + Pix:Age_centeredGrandmean2 + 
       (1|PSCID) + (1|id),
      data=clean_dat, REML=FALSE)


```


```{r simslopes, cache=TRUE, echo=TRUE}

# sim_slopes returns 
# Slopes: A table of coefficients for the focal predictor at each value of the moderator
# ints = A table of coefficients for the intercept at each value of the moderator
ss_PixAge = sim_slopes(model=lmer.fin, pred=Age_centeredGrandmean, 
           modx = Pix, modx.values = c(0,1), johnson_neyman=FALSE)
ss_CalAge = sim_slopes(model=lmer.fin, pred=Age_centeredGrandmean, 
           modx = CalVer, modx.values = c(0,1), johnson_neyman=FALSE)

ss_PixAge2 = sim_slopes(model=lmer.fin, pred=Age_centeredGrandmean2, 
           modx = Pix, modx.values = c(0,1), johnson_neyman=FALSE)

ss_CalAge2 = sim_slopes(model=lmer.fin, pred=Age_centeredGrandmean2, 
           modx = CalVer, modx.values = c(0,1), johnson_neyman=FALSE)

ss_PixAge$slopes
ss_CalAge$slopes
ss_PixAge2$slopes
ss_CalAge2$slopes
```

## Proportion of variance explains

# Table of models
```{r echo=TRUE}
mods = c(lmer.0, 
         lmer.2, # Quad fix ef of age
         lmer.3b, # Significant Control covariates 
         lmer.4, # Main effects of calver and pix
         lmer.6) # Interactions with AgexPix and AgexCalver
```


```{r h_model_table, cache=TRUE}


#my_labels = generate_labels(mods)

tab = tab_model(mods,
          show.std=TRUE, 
          show.est = FALSE,
          show.re.var  = FALSE, 
          show.p = FALSE, 
          show.aicc = TRUE, show.loglik = TRUE,
          pred.labels = c('(Intercept)',
                          'Age', 
                          'Age^2',
                          'Visit-level % interpolated',
                          'Visit-level fixation duration', 
                          'Visit-level tracker precision', 
                          'Person-level fixation duration', 
                          'Person-level tracker precision',
                          'Condition=Pixelated',
                          'Condition=Attention-Getter',
                          'Age x Attention-Getter',
                          'Age^2 x Attention-Getter',
                          'Age x Pixelated',
                          'Age^2 x Pixelated '),
          dv.labels = c('Model 1', 'Model 2', 
                        'Model 3', 'Model 4', 'Model 5'),
          string.std = 'Estimate (Std.)',
          string.std_ci ='95% CI',
          string.std.p = 'p (Std.)',
          css.summary='+font-weight:bold;')

tab
```




